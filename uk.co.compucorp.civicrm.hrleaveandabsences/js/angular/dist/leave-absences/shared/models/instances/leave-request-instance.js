define(["common/lodash","leave-absences/shared/modules/models-instances","common/models/option-group","common/models/instances/instance","common/services/file-upload"],function(e,t){"use strict";t.factory("LeaveRequestInstance",["$q","OptionGroup","FileUpload","shared-settings","ModelInstance","LeaveRequestAPI",function(t,n,i,s,a,o){function u(e){return r(e).then(function(e){return this.status_id=e.value,this.update()}.bind(this))}function l(e){return r(e).then(function(e){return this.status_id===e.value}.bind(this))}function c(){var n=[];return e.forEach(this.files,function(e){e.toBeDeleted&&n.push(o.deleteAttachment(this.id,e.attachment_id))}.bind(this)),t.all(n)}function r(e){return n.valuesOf("hrleaveandabsences_leave_request_status").then(function(t){return t.find(function(t){return t.name===e})})}function d(){var e=[],n=this;return n.comments.map(function(t,i){t.comment_id?t.toBeDeleted&&e.push(o.deleteComment(t.comment_id)):!function(i){e.push(o.saveComment(n.id,t).then(function(e){n.comments[i]=e}))}(i)}),t.all(e)}function h(){return this.fileUploader.queue&&this.fileUploader.queue.length>0?this.fileUploader.uploadAll({entityID:this.id}):t.resolve([])}return a.extend({defaultCustomData:function(){return{comments:[],files:[],request_type:"leave",fileUploader:i.uploader({entityTable:"civicrm_hrleaveandabsences_leave_request",crmAttachmentToken:s.attachmentToken,queueLimit:s.fileUploader.queueLimit,allowedMimeTypes:s.fileUploader.allowedMimeTypes})}},cancel:function(){return u.call(this,s.statusNames.cancelled)},approve:function(){return u.call(this,s.statusNames.approved)},reject:function(){return u.call(this,s.statusNames.rejected)},sendBack:function(){return u.call(this,s.statusNames.moreInformationRequired)},update:function(){return o.update(this.toAPI()).then(function(){return t.all([d.call(this),h.call(this),c.call(this)])}.bind(this))},create:function(){return o.create(this.toAPI()).then(function(e){return this.id=e.id,t.all([d.call(this),h.call(this)])}.bind(this))},deleteAttachment:function(e){e.toBeDeleted||(e.toBeDeleted=!0)},deleteComment:function(t){return t.comment_id?void(t.toBeDeleted=!0):void(this.comments=e.reject(this.comments,function(e){return t.created_at===e.created_at&&t.text===e.text}))},delete:function(){return o.delete(this.id)},isValid:function(){return o.isValid(this.toAPI())},isApproved:function(){return l.call(this,s.statusNames.approved)},isAwaitingApproval:function(){return l.call(this,s.statusNames.awaitingApproval)},isCancelled:function(){return l.call(this,s.statusNames.cancelled)},isRejected:function(){return l.call(this,s.statusNames.rejected)},isSentBack:function(){return l.call(this,s.statusNames.moreInformationRequired)},loadComments:function(){return this.id?o.getComments(this.id).then(function(e){this.comments=e}.bind(this)):t.resolve()},toAPIFilter:function(t,n,i){e.includes(["balance_change","dates","comments","fileUploader","files"],i)||(t[i]=this[i])},loadAttachments:function(){return this.id?o.getAttachments(this.id).then(function(e){this.files=e}.bind(this)):t.resolve()}})}])});