define(["common/lodash","leave-absences/shared/modules/controllers","leave-absences/shared/controllers/request-ctrl","leave-absences/shared/models/instances/toil-request-instance"],function(e,t){t.controller("ToilRequestCtrl",["$controller","$log","$q","$uibModalInstance","api.optionGroup","AbsenceType","directiveOptions","TOILRequestInstance",function(t,n,a,r,o,i,u,s){function l(){return q.uiOptions.multipleDays&&q.request.to_date||!q.uiOptions.multipleDays&&q.request.from_date}function c(){return d(q.uiOptions.multipleDays?{hasErrors:!q.request.to_date&&!q.request.from_date,label:"To Date",value:q.request.to_date}:{hasErrors:!q.request.from_date,label:"From Date",value:q.request.from_date})}function d(e){if(e.hasErrors){var t="Please select "+e.label+" to find expiry date";return a.reject([t])}return e.value?a.resolve(e.value):a.reject([])}function p(){q.canManage&&(q.uiOptions.expiryDate=q._convertDateFormatFromServer(q.request.toil_expiry_date))}function _(){return o.valuesOf("hrleaveandabsences_toil_amounts").then(function(t){q.toilAmounts=e.indexBy(t,"value")})}n.debug("ToilRequestCtrl");var f=t("RequestCtrl"),q=Object.create(f);return q.directiveOptions=u,q.$modalInstance=r,q.initParams={absenceType:{allow_accruals_request:!0}},q.calculateBalanceChange=function(){q.request.toil_to_accrue&&(q.loading.showBalanceChange=!0,q._setDateAndTypes(),q.balance.change.amount=+q.request.toil_to_accrue,q._calculateOpeningAndClosingBalance(),q.uiOptions.showBalance=!0,q.request.to_date_type=q.request.from_date_type="1",q.loading.showBalanceChange=!1)},q.calculateToilExpiryDate=function(){return!q.canManage&&q.request.id?a.resolve(q.request.toil_expiry_date):c().catch(function(e){return e.length&&(q.errors=e),a.reject(e)}).then(function(e){return i.calculateToilExpiryDate(q.request.type_id,e)}).then(function(e){return q.request.toil_expiry_date=e,e})},q.canSubmit=function(){return!!(q.request.toil_duration&&q.request.toil_to_accrue&&q.request.from_date&&q.request.to_date)},q.changeInNoOfDays=function(){f.changeInNoOfDays.call(this),l()&&q.calculateToilExpiryDate()},q.updateAbsencePeriodDatesTypes=function(e){var t=q.period.id;return q._checkAndSetAbsencePeriod(e).then(function(){var e=t===q.period.id;if(!e)return q.uiOptions.multipleDays&&(q.uiOptions.showBalance=!1,q.uiOptions.toDate=null,q.request.to_date=null),a.all([q._loadAbsenceTypes(),q._loadCalendar()])}).then(function(){q._setMinMaxDate(),q._setDates(),q.calculateToilExpiryDate(),q.updateBalance()}).catch(function(e){q.errors=[e]})},q.updateExpiryDate=function(){q.uiOptions.expiryDate&&(q.request.toil_expiry_date=q._convertDateToServerFormat(q.uiOptions.expiryDate))},q._initRequest=function(){var e=q._initRequestAttributes();q.request=s.init(e),q.request.to_date_type=q.request.from_date_type="1"},function(){q.loading.absenceTypes=!0,q._init().then(function(){return p(),_()}).finally(function(){q.loading.absenceTypes=!1})}(),q}])});