define(["leave-absences/shared/modules/controllers","common/lodash","common/moment","leave-absences/shared/models/absence-period-model","leave-absences/shared/models/absence-type-model","leave-absences/shared/models/public-holiday-model"],function(e,t,n){"use strict";function s(e,s,i,o,a,r,d,h){function l(e){var n=t.find(u,function(t){return t.name===e});return!!n&&n.value}var c=[],u=[],f=[];return this.absencePeriods=[],this.absenceTypes=[],this.leaveRequests={},this.months=[],this.monthLabels=n.monthsShort(),this.selectedMonths=[],this.selectedPeriod=null,this.loading={calendar:!1,page:!1},this.changeSelectedPeriod=function(){this._fetchMonthsFromPeriod(),this.refresh()},this.getAbsenceTypeStyle=function(e){return{backgroundColor:e.color,borderColor:e.color}},this.getDayName=function(e){return this._getDateObjectWithFormat(e).format("ddd")},this.isPublicHoliday=function(e){return!!f[this._getDateObjectWithFormat(e).valueOf()]},this.labelPeriod=function(e){return e.current?"Current Period ("+e.title+")":e.title},this._fetchMonthsFromPeriod=function(){for(var e=[],t=n(this.selectedPeriod.start_date),s=n(this.selectedPeriod.end_date);t.isBefore(s);)e.push(this._getMonthSkeleton(t)),t.add(1,"month");this.months=e},this._getDateObjectWithFormat=function(e){return n(e,i.serverDateFormat)},this._getMonthObjectByDate=function(e,n){return t.find(n,function(t){return t.month===e.month()&&t.year===e.year()})},this._getStyles=function(e,n){var s;return n.leaveRequest=e,s=t.find(this.absenceTypes,function(t){return t.id===e.type_id}),e.balance_change>0?(n.UI.isAccruedTOIL=!0,{borderColor:s.color}):{backgroundColor:s.color,borderColor:s.color}},this._init=function(t){this.loading.page=!0,this.selectedMonths=[this.monthLabels[n().month()]],e.all([this._loadAbsencePeriods(),this._loadAbsenceTypes(),this._loadPublicHolidays(),this._loadStatuses(),this._loadDayTypes()]).then(function(){return t?t():null}).then(function(){return this.legendCollapsed=!1,this._loadLeaveRequestsAndCalendar()}.bind(this)).finally(function(){this.loading.page=!1}.bind(this))},this._isDayType=function(e,t,s){var i=c[e];return n(s).isSame(t.from_date)?i.value===t.from_date_type:n(s).isSame(t.to_date)?i.value===t.to_date_type:void 0},this._isPendingApproval=function(e){var t=u[e.status_id];return t.name===i.statusNames.awaitingApproval},this._loadAbsencePeriods=function(){return o.all().then(function(e){this.absencePeriods=t.sortBy(e,"start_date"),this.selectedPeriod=t.find(this.absencePeriods,function(e){return!!e.current}),this._fetchMonthsFromPeriod()}.bind(this))},this._loadAbsenceTypes=function(){return a.all({is_active:!0}).then(function(e){this.absenceTypes=e}.bind(this))},this._loadDayTypes=function(){return h.valuesOf("hrleaveandabsences_leave_request_day_type").then(function(e){c=t.indexBy(e,"name")})},this._loadLeaveRequestsAndCalendar=function(e,t,n){t=void 0===t||t;var s={from_date:{from:this.selectedPeriod.start_date},to_date:{to:this.selectedPeriod.end_date},status_id:{IN:[l(i.statusNames.approved),l(i.statusNames.adminApproved),l(i.statusNames.awaitingApproval)]}};return s[e]=this.contactId,r.all(s,{},null,null,t).then(function(e){return this._indexLeaveRequests(e.list),this._loadCalendar()}.bind(this)).then(function(){n&&n(),this.loading.calendar=!1,this._showMonthLoader()}.bind(this))},this._loadPublicHolidays=function(){return d.all().then(function(e){f=t.transform(e,function(e,t){e[this._getDateObjectWithFormat(t.date).valueOf()]=t}.bind(this),{})}.bind(this))},this._loadStatuses=function(){return h.valuesOf("hrleaveandabsences_leave_request_status").then(function(e){u=t.indexBy(e,"value")})},this._resetMonths=function(){t.each(this.months,function(e){e.data=[]})},this._showMonthLoader=function(){var e=500,t=0;this.months.forEach(function(n){n.loading=n.label!==this.selectedMonths[0],n.loading&&(s(function(){n.loading=!1},t),t+=e)}.bind(this))},this}e.controller("CalendarCtrl",["$q","$timeout","shared-settings","AbsencePeriod","AbsenceType","LeaveRequest","PublicHoliday","OptionGroup",s])});