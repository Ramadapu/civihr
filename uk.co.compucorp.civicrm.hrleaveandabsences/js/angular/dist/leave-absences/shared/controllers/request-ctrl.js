define(["common/angular","leave-absences/shared/modules/controllers","common/lodash","common/moment","common/services/api/option-group","common/services/hr-settings","common/models/contact","leave-absences/shared/models/absence-period-model","leave-absences/shared/models/absence-type-model","leave-absences/shared/models/calendar-model","leave-absences/shared/models/entitlement-model","leave-absences/shared/models/leave-request-model","leave-absences/shared/models/public-holiday-model"],function(t,e,i,s){"use strict";e.controller("RequestCtrl",["$log","$q","$rootScope","Contact","dialog","AbsencePeriod","AbsenceType","api.optionGroup","checkPermissions","Calendar","Entitlement","HR_settings","LeaveRequest","PublicHoliday","shared-settings",function(e,n,a,o,r,u,h,c,l,d,p,f,m,_,v){function g(){return!!(this.request.from_date&&this.request.to_date&&this.request.from_date_type&&this.request.to_date_type)}function y(){this.isSelfRecord?this.request.status_id=this.requestStatuses[v.statusNames.awaitingApproval].value:this.canManage&&(this.request.status_id=this.newStatusOnSave||this.request.status_id)}function b(){return this.request.create().then(function(){$.call(this,"LeaveRequest::new")}.bind(this))}function q(t,e){var i,s,a=n.defer();return t||a.reject([]),s=this.requestDayTypes.slice(0),t=this._convertDateToServerFormat(t),_.isPublicHoliday(t).then(function(n){n?s=s.filter(function(t){return"public_holiday"===t.name}):(i=S.call(this,t,s),s=i.length?i:s.filter(function(t){return"all_day"===t.name||"half_day_am"===t.name||"half_day_pm"===t.name})),E.call(this,e,s),a.resolve(s)}.bind(this)),a.promise}function D(){var t=this.getStatusFromValue(this.request.status_id);return O.call(this,t.name)}function O(t){return i.map(J[t],function(t){return this.requestStatuses[t]}.bind(this))}function T(){return i.pick(this.request,["contact_id","from_date","from_date_type","to_date","to_date_type"])}function S(t,e){var i=null;return this.calendar.isNonWorkingDay(s(t))?i="non_working_day":this.calendar.isWeekend(s(t))&&(i="weekend"),i?e.filter(function(t){return t.name===i}):[]}function C(){return i.find(this.absenceTypes,function(t){return t.id===this.request.type_id}.bind(this))}function w(t){this.errors=i.isArray(t)?t:[t],this.loading.showBalanceChange=!1,this.loading.absenceTypes=!1,this.loading.fromDayTypes=!1,this.loading.toDayTypes=!1,this.submitting=!1}function A(){return!t.equals(i.omit(K,"fileUploader"),i.omit(this.request.attributes(),"fileUploader"))||0!==this.request.fileUploader.queue.length||this.canManage&&this.newStatusOnSave}function M(){var t=[v.statusNames.moreInformationRequired,v.statusNames.approved,v.statusNames.rejected,v.statusNames.cancelled];J.none=[v.statusNames.moreInformationRequired,v.statusNames.approved],J.awaiting_approval=t,J.more_information_required=t,J.rejected=t,J.approved=t,J.cancelled=[v.statusNames.awaitingApproval].concat(t)}function R(){if(this.request.id){this.mode="edit";var t=[this.requestStatuses[v.statusNames.approved].value,this.requestStatuses[v.statusNames.adminApproved].value,this.requestStatuses[v.statusNames.rejected].value,this.requestStatuses[v.statusNames.cancelled].value];this.isRole("staff")&&t.indexOf(this.request.status_id)>-1&&(this.mode="view")}else this.mode="create"}function F(){this.period=i.find(this.absencePeriods,function(t){return t.current})}function P(){if(this.isMode("create"))return n.resolve();var t=this.request.attributes();return this.uiOptions.fromDate=this._convertDateFormatFromServer(this.request.from_date),this.updateAbsencePeriodDatesTypes(this.uiOptions.fromDate,"from").then(function(){return this.request.to_date=t.to_date,this.request.to_date_type=t.to_date_type,this.uiOptions.toDate=this._convertDateFormatFromServer(this.request.to_date),this.updateAbsencePeriodDatesTypes(this.uiOptions.toDate,"to")}.bind(this))}function k(){return Q="staff",l(v.permissions.admin.administer).then(function(t){Q=t?"admin":Q}).then(function(){return"staff"===Q&&l(v.permissions.ssp.manage).then(function(t){Q=t?"manager":Q})}).finally(function(){this.canManage=this.isRole("manager")||this.isRole("admin"),this.isSelfRecord=this.directiveOptions.isSelfRecord}.bind(this))}function B(){(this.isRole("admin")||this.isMode("create")&&this.isRole("manager"))&&(this.newStatusOnSave=this.requestStatuses[v.statusNames.approved].value)}function N(){return this.canManage?o.find(this.request.contact_id).then(function(t){this.contactName=t.display_name}.bind(this)):n.resolve()}function I(){return this.directiveOptions.selectedContactId?o.find(this.directiveOptions.selectedContactId).then(function(t){this.managedContacts=[t]}.bind(this)):this.isRole("admin")?o.all().then(function(t){this.managedContacts=i.remove(t.list,function(t){return t.id!==this.directiveOptions.contactId}.bind(this))}.bind(this)):o.find(this.directiveOptions.contactId).then(function(t){return t.leaveManagees()}).then(function(t){this.managedContacts=t}.bind(this))}function x(){var t=this;return u.all().then(function(e){t.absencePeriods=e})}function j(){var t=this;return c.valuesOf("hrleaveandabsences_leave_request_day_type").then(function(e){t.requestDayTypes=e})}function L(){var t=this;return c.valuesOf("hrleaveandabsences_leave_request_status").then(function(e){t.requestStatuses=i.indexBy(e,"name")})}function U(t,e){return e.map(function(e){var s=i.find(t,function(t){return t.id===e.type_id});return{id:e.type_id,title:s.title+" ( "+e.remainder.current+" ) ",remainder:e.remainder.current,allow_overuse:s.allow_overuse}})}function $(t){a.$emit(t,this.request),this.errors=[],this.ok()}function H(){this.pagination.totalItems=this.balance.change.breakdown.length,this.pagination.filteredbreakdown=this.balance.change.breakdown,this.pagination.pageChanged()}function V(){this.isMode("create")?(this.selectedAbsenceType=this.absenceTypes[0],this.request.type_id=this.selectedAbsenceType.id):this.selectedAbsenceType=C.call(this)}function W(t){var e=this;return p.all({contact_id:e.request.contact_id,period_id:e.period.id,type_id:{IN:t.ids}},!0).then(function(i){if(e.absenceTypes=U(t.types,i),!e.absenceTypes.length)return n.reject(X)})}function E(t,e){var s="request"+i.startCase(t)+"DayTypes";this[s]=e,this.isMode("create")&&(this.request[t+"_date_type"]=this[s][0].value)}function G(){return this.request.update().then(function(){this.isRole("manager")?$.call(this,"LeaveRequest::updatedByManager"):(this.isRole("staff")||this.isRole("admin"))&&$.call(this,"LeaveRequest::edit")}.bind(this))}function Y(){return this.balance.closing<0&&"0"===this.selectedAbsenceType.allow_overuse?n.reject(["You are not allowed to apply leave in negative"]):this.request.isValid()}e.debug("RequestCtrl");var z,J={},K={},Q="",X="No entitlement";this.absencePeriods=[],this.absenceTypes=[],this.calendar={},this.canManage=!1,this.contactName=null,this.errors=[],this.isSelfRecord=!1,this.managedContacts=[],this.mode="",this.newStatusOnSave=null,this.period={},this.postContactSelection=!1,this.requestDayTypes=[],this.requestStatuses={},this.selectedAbsenceType={},this.statusNames=v.statusNames,this.submitting=!1,this.supportedFileTypes="",this.today=Date.now(),this.balance={closing:0,opening:0,change:{amount:0,breakdown:[]}},this.loading={absenceTypes:!0,showBalanceChange:!1,fromDayTypes:!1,toDayTypes:!1};var Z=this;return this.pagination={currentPage:1,filteredbreakdown:this.balance.change.breakdown,numPerPage:5,totalItems:this.balance.change.breakdown.length,pageChanged:function(){var t=(this.currentPage-1)*this.numPerPage,e=t+this.numPerPage;this.filteredbreakdown=Z.balance.change.breakdown.slice(t,e)}},this.uiOptions={isChangeExpanded:!1,multipleDays:!0,userDateFormat:f.DATE_FORMAT,userDateFormatWithTime:f.DATE_FORMAT+" HH:mm",showBalance:!1,date:{from:{show:!1,options:{startingDay:1,showWeeks:!1}},to:{show:!1,options:{minDate:null,maxDate:null,startingDay:1,showWeeks:!1}},expiry:{show:!1,options:{minDate:null,maxDate:null,startingDay:1,showWeeks:!1}}}},this.changeInNoOfDays=function(){this._reset(),this._calculateOpeningAndClosingBalance()},this.calculateBalanceChange=function(){var t=this;return t._setDateAndTypes(),g.call(t)?(t.errors=[],t.loading.showBalanceChange=!0,m.calculateBalanceChange(T.call(t)).then(function(e){e&&(t.balance.change=e,t._calculateOpeningAndClosingBalance(),H.call(t)),t.loading.showBalanceChange=!1}).catch(w.bind(t))):n.resolve()},this.canSubmit=function(){var t=g.call(this);return this.isMode("edit")&&(t=t&&A.call(this)),this.canManage&&this.requestStatuses&&(t=t&&!!this.getStatusFromValue(this.newStatusOnSave)),t=t&&!!this.period.id,t&&!this.isMode("view")},this.canUploadMore=function(){return this.getFilesCount()<v.fileUploader.queueLimit},this.closeAlert=function(){this.errors=[]},this.deleteLeaveRequest=function(){r.open({title:"Confirm Deletion?",copyCancel:"Cancel",copyConfirm:"Confirm",classConfirm:"btn-danger",msg:"This cannot be undone",onConfirm:function(){return this.directiveOptions.leaveRequest.delete().then(function(){this.dismissModal(),a.$emit("LeaveRequest::deleted",this.directiveOptions.leaveRequest)}.bind(this))}.bind(this)})},this.dismissModal=function(){this.$modalInstance.dismiss({$value:"cancel"})},this.getFilesCount=function(){var t=i.filter(this.request.files,function(t){return t.toBeDeleted});return this.request.files.length+this.request.fileUploader.queue.length-t.length},this.formatDateTime=function(t){return s(t,v.serverDateTimeFormat).format(this.uiOptions.userDateFormat.toUpperCase()+" HH:mm")},this.getStatuses=function(){return!this.request||t.equals({},this.requestStatuses)?[]:this.request.status_id?D.call(this):O.call(this,"none")},this.getStatusFromValue=function(t){return i.find(this.requestStatuses,function(e){return e.value===t})},this.initAfterContactSelection=function(){var e=this;return e.postContactSelection=!0,e.request.contact_id?n.all([e._loadAbsenceTypes(),e._loadCalendar()]).then(function(){return j.call(e)}).then(function(){return P.call(e)}).then(function(){return V.call(e),B.call(e),N.call(e),e.isMode("edit")&&(K=t.copy(e.request.attributes()),e.request.from_date===e.request.to_date&&(e.uiOptions.multipleDays=!1)),e.postContactSelection=!1,e.calculateBalanceChange()}).catch(function(t){if(t!==X)return n.reject(t)}):n.reject("The contact id was not set")},this.isLeaveStatus=function(t){var e=this.getStatusFromValue(this.request.status_id);return!!e&&e.name===t},this.isLeaveType=function(t){return this.request.request_type===t},this.isMode=function(t){return this.mode===t},this.isRole=function(t){return Q===t},this.ok=function(){this.$modalInstance.close({$value:this.request})},this.removeAttachmentVisibility=function(t){return!t.attachment_id||this.canManage},this.submit=function(){var t=this.request.status_id;this.isMode("view")||this.submitting||(this.submitting=!0,y.call(this),Y.call(this).then(function(){return this.isMode("edit")?G.call(this):b.call(this)}.bind(this)).catch(function(e){this.request.status_id=t,e&&w.call(this,e)}.bind(this)).finally(function(){this.submitting=!1}.bind(this)))},this.updateAbsencePeriodDatesTypes=function(t,e){var i=this,s=i.period.id;return e=e||"from",i.loading[e+"DayTypes"]=!0,i._checkAndSetAbsencePeriod(t).then(function(){var t=s===i.period.id;if(!t)return i.uiOptions.multipleDays&&"from"===e&&(i.uiOptions.showBalance=!1,i.uiOptions.toDate=null,i.request.to_date=null,i.request.to_date_type=null),n.all([i._loadAbsenceTypes(),i._loadCalendar()])}).then(function(){return i._setMinMaxDate(),q.call(i,t,e)}).then(function(){return i.updateBalance()}).catch(function(t){i.errors=[t],i._setDateAndTypes()}).finally(function(){i.loading[e+"DayTypes"]=!1})},this.updateBalance=function(){this.selectedAbsenceType=C.call(this),this.balance.opening=this.selectedAbsenceType.remainder,this.calculateBalanceChange()},this._calculateOpeningAndClosingBalance=function(){this.balance.opening=this.selectedAbsenceType.remainder,this.balance.closing=this.balance.opening+this.balance.change.amount},this._checkAndSetAbsencePeriod=function(t){var e=s(t).format(this.uiOptions.userDateFormat.toUpperCase());return this.period=i.find(this.absencePeriods,function(t){return t.isInPeriod(e)}),this.period?n.resolve(!0):(this.period={},this.loading.fromDayTypes=!1,n.reject("Please change date as it is not in any absence period"))},this._convertDateToServerFormat=function(t){return s(t).format(v.serverDateFormat)},this._convertDateFormatFromServer=function(t){return s(t,v.serverDateFormat).toDate()},this._init=function(){return this.supportedFileTypes=i.keys(v.fileUploader.allowedMimeTypes),M.call(this),k.call(this).then(function(){return this._initRequest()}.bind(this)).then(function(){return L.call(this)}.bind(this)).then(function(){return R.call(this),this.canManage&&!this.isMode("edit")&&I.call(this)}.bind(this)).then(function(){return x.call(this)}.bind(this)).then(function(){return F.call(this),this._setMinMaxDate(),this.request.loadAttachments()}.bind(this)).then(function(){if(this.directiveOptions.selectedContactId&&(this.request.contact_id=this.directiveOptions.selectedContactId),this.request.contact_id)return this.initAfterContactSelection()}.bind(this)).catch(w.bind(this))},this._initRequestAttributes=function(){var t={};return this.directiveOptions.leaveRequest?t=this.directiveOptions.leaveRequest.attributes():this.canManage||(t={contact_id:this.directiveOptions.contactId}),t},this._loadCalendar=function(){var t=this;return d.get(t.request.contact_id,t.period.id).then(function(e){t.calendar=e})},this._loadAbsenceTypes=function(){var t=this;return h.all(t.initParams.absenceType).then(function(e){var i=e.map(function(t){return t.id});return z={types:e,ids:i},W.call(t,z)})},this._reset=function(){this.uiOptions.toDate=this.uiOptions.fromDate,this.request.to_date_type=this.request.from_date_type,this.request.to_date=this.request.from_date,this.calculateBalanceChange()},this._setDates=function(){this.request.from_date=this.uiOptions.fromDate?this._convertDateToServerFormat(this.uiOptions.fromDate):null,this.request.to_date=this.uiOptions.toDate?this._convertDateToServerFormat(this.uiOptions.toDate):null,!this.uiOptions.multipleDays&&this.uiOptions.fromDate&&(this.uiOptions.toDate=this.uiOptions.fromDate,this.request.to_date=this.request.from_date)},this._setDateAndTypes=function(){this._setDates(),this.uiOptions.multipleDays?this.uiOptions.showBalance=!!(this.request.from_date&&this.request.from_date_type&&this.request.to_date&&this.request.to_date_type&&this.period.id):(this.uiOptions.fromDate&&(this.request.to_date_type=this.request.from_date_type),this.uiOptions.showBalance=!!this.request.from_date&&!!this.request.from_date_type&&!!this.period.id)},this._setMinMaxDate=function(){if(this.uiOptions.fromDate){var t=s(this.uiOptions.fromDate).add(1,"d").toDate();this.uiOptions.date.to.options.minDate=t,this.uiOptions.date.to.options.initDate=t,this.uiOptions.toDate&&s(this.uiOptions.toDate).isBefore(this.uiOptions.fromDate)&&(this.uiOptions.toDate=this.uiOptions.fromDate)}else this.uiOptions.date.to.options.minDate=this._convertDateFormatFromServer(this.period.start_date),this.uiOptions.date.to.options.initDate=this.uiOptions.date.to.options.minDate;this.uiOptions.date.to.options.maxDate=this._convertDateFormatFromServer(this.period.end_date)},this}])});