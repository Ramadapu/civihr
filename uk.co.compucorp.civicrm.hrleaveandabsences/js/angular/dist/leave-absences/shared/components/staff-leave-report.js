define(["common/lodash","common/moment","leave-absences/shared/modules/components"],function(e,t,n){function a(n,a,o,i,r,c,d,s,l,u,f,p){function m(e){return e.loading=!0,e.loadFn().then(function(){e.loading=!1})}function h(e){var n=$.absenceTypes[e.type_id].allow_request_cancelation;return"admin"===E||("3"===n?t().isBefore(e.from_date):"2"===n)}function _(){Object.values($.sections).filter(function(e){return!e.open}).forEach(function(e){e.data=[]})}function v(){return l.valuesOf("hrleaveandabsences_leave_request_status").then(function(t){$.leaveRequestStatuses=e.indexBy(t,"value")})}function g(){return r.all().then(function(t){$.absencePeriods=e.sortBy(t,"start_date"),$.selectedPeriod=e.find($.absencePeriods,function(e){return e.current===!0})})}function b(){return c.all().then(function(t){$.absenceTypes=e.indexBy(t,"id")})}function y(){return s.all({contact_id:$.contactId,from_date:{from:$.selectedPeriod.start_date},to_date:{to:$.selectedPeriod.end_date},status_id:S(p.statusNames.approved)},null,j).then(function(e){$.sections.approved.data=e.list})}function P(){return a.all([s.balanceChangeByAbsenceType($.contactId,$.selectedPeriod.id,null,!0),s.balanceChangeByAbsenceType($.contactId,$.selectedPeriod.id,[S(p.statusNames.approved)]),s.balanceChangeByAbsenceType($.contactId,$.selectedPeriod.id,[S(p.statusNames.awaitingApproval),S(p.statusNames.moreInformationRequired)])]).then(function(t){e.forEach($.absenceTypes,function(e){e.balanceChanges={publicHolidays:t[0][e.id],approved:t[1][e.id],pending:t[2][e.id]}})})}function T(){return d.all({contact_id:$.contactId,period_id:$.selectedPeriod.id},!0).then(function(e){$.entitlements=e}).then(function(){$.absenceTypesFiltered=e.filter($.absenceTypes,function(t){var n=e.find($.entitlements,function(e){return e.type_id===t.id});return t.entitlement=n?n.value:0,t.remainder=n?n.remainder:{current:0,future:0},!(0===t.entitlement&&"1"!==t.allow_overuse&&"1"!==t.allow_accruals_request)})})}function C(){return d.breakdown({contact_id:$.contactId,period_id:$.selectedPeriod.id},$.entitlements).then(function(){return R($.entitlements)}).then(function(e){$.sections.entitlements.data=e})}function I(){return a.all([d.breakdown({contact_id:$.contactId,period_id:$.selectedPeriod.id,expired:!0}),s.all({contact_id:$.contactId,from_date:{from:$.selectedPeriod.start_date},to_date:{to:$.selectedPeriod.end_date},request_type:"toil",expired:!0},null,j)]).then(function(e){return a.all({expiredBalanceChangesFlatten:R(e[0]),expiredTOILS:x(e[1].list)})}).then(function(e){$.sections.expired.data=e.expiredBalanceChangesFlatten.concat(e.expiredTOILS)})}function q(){return a.all(Object.values($.sections).filter(function(e){return e.open}).map(function(e){return m(e)}))}function w(){return s.all({contact_id:$.contactId,from_date:{from:$.selectedPeriod.start_date},to_date:{to:$.selectedPeriod.end_date},status_id:{in:[S(p.statusNames.rejected),S(p.statusNames.cancelled)]}},null,j).then(function(e){$.sections.other.data=e.list})}function A(){return s.all({contact_id:$.contactId,from_date:{from:$.selectedPeriod.start_date},to_date:{to:$.selectedPeriod.end_date},status_id:{in:[S(p.statusNames.awaitingApproval),S(p.statusNames.moreInformationRequired)]}},null,j,null,!1).then(function(e){$.sections.pending.data=e.list})}function F(){return s.all({contact_id:$.contactId,from_date:{from:$.selectedPeriod.start_date},to_date:{to:$.selectedPeriod.end_date},public_holiday:!0},null,j).then(function(e){$.sections.holidays.data=e.list})}function R(t){return a.resolve().then(function(){return t.map(function(t){var n=e.find($.entitlements,function(e){return e.id===t.id});return t.breakdown.map(function(t){return e.assign(e.clone(t),{type_id:n.type_id})})})}).then(function(e){return Array.prototype.concat.apply([],e)})}function x(e){return a.resolve().then(function(){return e.map(function(e){return{expiry_date:e.toil_expiry_date,type:{label:"Accrued TOIL"}}})})}function N(){o.$on("LeaveRequest::new",function(){$.refresh()}),o.$on("LeaveRequest::edit",function(){$.refresh()}),o.$on("LeaveRequest::deleted",function(e,t){O(t)})}function O(t,n){var a;["approved","pending","other"].forEach(function(n){var o=e.remove($.sections[n].data,function(e){return e.id===t.id});o.length&&(a=n)}),"other"!==a&&(B(t,a),n&&$.sections.other.data.length&&$.sections.other.data.push(t))}function B(e,t){var n=$.absenceTypes[e.type_id],a="pending"===t?"future":"current";n.balanceChanges[t]-=e.balance_change,n.remainder[a]-=e.balance_change}function S(t){return e.find($.leaveRequestStatuses,function(e){return e.name===t}).value}n.debug("Component: staff-leave-report");var L={};L[p.statusNames.awaitingApproval]=["edit","cancel","delete"],L[p.statusNames.moreInformationRequired]=["respond","cancel","delete"],L[p.statusNames.approved]=["view","cancel","delete"],L[p.statusNames.cancelled]=["view","delete"],L[p.statusNames.rejected]=["view","delete"];var j="from_date DESC",E="staff",$=Object.create(this);return $.absencePeriods=[],$.absenceTypes={},$.absenceTypesFiltered={},$.dateFormat=f.DATE_FORMAT,$.leaveRequestStatuses={},$.selectedPeriod=null,$.loading={content:!0,page:!0},$.sections={approved:{open:!1,data:[],loading:!1,loadFn:y},entitlements:{open:!1,data:[],loading:!1,loadFn:C},expired:{open:!1,data:[],loading:!1,loadFn:I},holidays:{open:!1,data:[],loading:!1,loadFn:F},pending:{open:!1,data:[],loading:!1,loadFn:A},other:{open:!1,data:[],loading:!1,loadFn:w}},$.actionsFor=function(t){var n=$.leaveRequestStatuses[t.status_id].name,a=n?L[n]:[];return h(t)||(a=e.without(a,"cancel")),"admin"===E?e.includes(a,"edit")?a=a.join(",").replace("edit","respond").split(","):e.includes(a,"respond")&&(a=a.join(",").replace("respond","edit").split(",")):a=e.without(a,"delete"),a},$.action=function(e,t){~["cancel","delete"].indexOf(t)&&u.open({title:"Confirm "+("cancel"===t?"Cancellation":"Deletion")+"?",copyCancel:"Cancel",copyConfirm:"Confirm",classConfirm:"btn-danger",msg:"Are you sure you want to "+t+" this leave record? This cannot be undone",onConfirm:function(){return e[t]()}}).then(function(n){!!n&&O(e,"cancel"===t)})},$.labelPeriod=function(e){return e.current?"Current Period ("+e.title+")":e.title},$.refresh=function(){$.loading.content=!0,a.all([T(),P()]).then(function(){$.loading.content=!1}).then(function(){return a.all([q(),_()])})},$.toggleSection=function(e){var t=$.sections[e];t.open=!t.open,t.open&&!t.data.length&&m(t)},function(){i(p.permissions.admin.administer).then(function(e){E=e?"admin":E}).then(function(){return a.all([v(),b(),g()])}).then(function(){$.loading.page=!1}).then(function(){return a.all([T(),P()])}).then(function(){$.loading.content=!1}),N()}(),$}n.component("staffLeaveReport",{bindings:{contactId:"<"},templateUrl:["shared-settings",function(e){return e.sharedPathTpl+"components/staff-leave-report.html"}],controllerAs:"report",controller:["$log","$q","$rootScope","checkPermissions","AbsencePeriod","AbsenceType","Entitlement","LeaveRequest","OptionGroup","dialog","HR_settings","shared-settings",a]})});