define(["common/lodash","leave-absences/shared/modules/components","common/models/contact"],function(e,t){function n(t,n,a,s,r,l,i,u,o,c,f){"use strict";function d(){var e=T.filters.contact;return{department:e.department,level_type:e.level_type,location:e.location,region:e.region}}function v(){return i.all().then(function(t){T.absencePeriods=e.sortBy(t,"start_date"),T.filters.leaveRequest.selectedPeriod=e.find(T.absencePeriods,function(e){return!!e.current})})}function p(){return u.all().then(function(e){T.absenceTypes=e})}function m(){return T.loading.content=!0,(T.isAdmin?l.all(d()):l.leaveManagees(T.contactId,d())).then(function(e){return T.filteredUsers=T.isAdmin?e.list:e,n.all([b("table"),b("filter")])}).then(function(){T.loading.content=!1})}function g(){return c.valuesOf("hrjc_department").then(function(e){T.departments=e})}function b(e){var t="filter"!==e,n="filter"===e?{size:0}:T.pagination,a="filter"===e?{return:["status_id"]}:{};return o.all(q(t),n,"from_date DESC",a,!1).then(function(t){T.leaveRequests[e]=t})}function h(){return c.valuesOf("hrjc_level_type").then(function(e){T.levelTypes=e})}function y(){return c.valuesOf("hrjc_location").then(function(e){T.locations=e})}function q(e){var t=T.filters.leaveRequest;return{contact_id:A(),managed_by:T.isAdmin&&"me"!==t.assignedTo?void 0:T.contactId,status_id:S(e),type_id:t.selectedAbsenceTypes?t.selectedAbsenceTypes.id:null,from_date:{from:t.selectedPeriod.start_date},to_date:{to:t.selectedPeriod.end_date},unassigned:"unassigned"===t.assignedTo}}function _(){return c.valuesOf("hrjc_region").then(function(e){T.regions=e})}function R(){return c.valuesOf("hrleaveandabsences_leave_request_status").then(function(e){T.leaveRequestStatuses=e.concat(T.leaveRequestStatuses)})}function A(){return T.filteredUsers.length>0&&T.filters.leaveRequest.contact_id?T.filters.leaveRequest.contact_id:{IN:T.filteredUsers.map(function(e){return e.id})}}function S(t){var n=T.filters.leaveRequest,a=[],r=e.find(T.leaveRequestStatuses,function(e){return e.name===s.statusNames.awaitingApproval}).value;if(t&&n.leaveStatus&&n.leaveStatus.value&&a.push(n.leaveStatus.value),n.pending_requests&&r&&a.push(r),a.length)return{IN:a}}function P(){a.$on("LeaveRequest::updatedByManager",T.refresh),a.$on("LeaveRequest::new",T.refresh)}t.debug("Component: manage-leave-requests");var T=this,C={};C[s.statusNames.awaitingApproval]=["respond","cancel","approve","reject"],C[s.statusNames.moreInformationRequired]=["edit","cancel"],C[s.statusNames.approved]=["edit"],C[s.statusNames.cancelled]=["edit"],C[s.statusNames.rejected]=["edit"],T.absencePeriods=[],T.absenceTypes=[],T.filteredUsers=[],T.isFilterExpanded=!1,T.isAdmin=!1,T.leaveRequestStatuses=[{name:"all",label:"All"}],T.filters={contact:{department:null,level_type:null,location:null,region:null},leaveRequest:{leaveStatus:T.leaveRequestStatuses[0],pending_requests:!1,contact_id:null,selectedPeriod:null,selectedAbsenceTypes:null,assignedTo:"all"}},T.filtersByAssignee=[{type:"all",label:"All"},{type:"unassigned",label:"Unassigned"},{type:"me",label:"Assigned To Me"}],T.leaveRequests={table:{list:[]},filter:{list:[]}},T.loading={content:!0,page:!0},T.pagination={page:1,size:7},T.actionsFor=function(t){var n=e.find(T.leaveRequestStatuses,function(e){return!!e.value&&e.value===t.status_id}).name;return n?C[n]:[]},T.action=function(e,t){var n={cancel:{title:"Cancellation",btnClass:"danger",btnLabel:"Confirm",msg:"This cannot be undone"},approve:{title:"Approval",btnClass:"success",btnLabel:"Approve",msg:"Please confirm approval"},reject:{title:"Rejection",btnClass:"warning",btnLabel:"Reject",msg:"Please confirm rejection"}};f.open({title:"Confirm "+n[t].title+"?",copyCancel:"Cancel",copyConfirm:n[t].btnLabel,classConfirm:"btn-"+n[t].btnClass,msg:n[t].msg,onConfirm:function(){return e[t]()}})},T.clearStaffSelection=function(){T.filters.leaveRequest.contact_id=null,T.refresh()},T.filterLeaveRequestByStatus=function(e){return"all"===e.name||""===e?T.leaveRequests.filter.list:T.leaveRequests.filter.list.filter(function(t){return t.status_id===e.value})},T.getAbsenceTypesByID=function(t){if(T.absenceTypes&&t){var n=e.find(T.absenceTypes,function(e){return e.id===t});return n?n.title:null}},T.getLeaveStatusByValue=function(t){var n=e.find(T.leaveRequestStatuses,function(e){return e.value===t});return n?n.label:null},T.getNavBadge=function(e){switch(e){case s.statusNames.approved:return"badge-success";case s.statusNames.rejected:return"badge-danger";case s.statusNames.cancelled:case"all":return"";default:return"badge-primary"}},T.getUserNameByID=function(t){var n=e.find(T.filteredUsers,function(e){return e.id===t});return n?n.display_name:null},T.labelPeriod=function(e){return e.current?"Current Period ("+e.title+")":e.title},T.getArrayOfSize=function(e){return new Array(e||0)},T.refresh=function(e){e="number"==typeof e?e:1,(e<=T.totalNoOfPages()||0===T.totalNoOfPages())&&(T.pagination.page=e,m())},T.refreshWithFilter=function(e){T.filters.leaveRequest.leaveStatus=e,T.refresh()},T.refreshWithFilterByAssignee=function(e){T.filters.leaveRequest.assignedTo=e,T.refresh()},T.totalNoOfPages=function(){return Math.ceil(T.leaveRequests.table.total/T.pagination.size)},function(){r(s.permissions.admin.administer).then(function(e){T.isAdmin=e,n.all([v(),p(),_(),g(),y(),h(),R()]).then(function(){T.loading.page=!1,m()}),P()})}()}t.component("manageLeaveRequests",{bindings:{contactId:"<"},templateUrl:["shared-settings",function(e){return e.sharedPathTpl+"components/manage-leave-requests.html"}],controllerAs:"vm",controller:["$log","$q","$rootScope","shared-settings","checkPermissions","Contact","AbsencePeriod","AbsenceType","LeaveRequest","OptionGroup","dialog",n]})});