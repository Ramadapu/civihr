define(["common/lodash","common/moment","leave-absences/shared/modules/components","leave-absences/shared/controllers/calendar-ctrl","common/models/contact"],function(e,t,n){function a(n,a,o,r,l,c,i,s,d){a.debug("Component: manager-leave-calendar");var u,f=n("CalendarCtrl"),_=Object.create(f),m=!1,h=[];return _.filteredContacts=[],_.managedContacts=[],_.filters={contact:null,department:null,level_type:null,location:null,region:null,contacts_with_leaves:!1},_.filterContacts=function(){return _.filters.contacts_with_leaves?_.filteredContacts.filter(function(e){return _.leaveRequests[e.id]&&Object.keys(_.leaveRequests[e.id]).length>0}):_.filteredContacts},_.getMonthData=function(t,n){var a,o=e.find(_.managedContacts,function(e){return+e.id===+t});if(o&&o.calendarData)return a=e.find(o.calendarData,function(e){return e.month===n.month&&e.year===n.year}),a?a.data:[]},_.refresh=function(){_.loading.calendar=!0,_._resetMonths(),_._loadContacts().then(function(){_._loadLeaveRequestsAndCalendar()})},_._getMonthSkeleton=function(e){return{month:e.month(),year:e.year()}},_._indexLeaveRequests=function(t){_.leaveRequests={},e.each(t,function(t){_.leaveRequests[t.contact_id]=_.leaveRequests[t.contact_id]||{},e.each(t.dates,function(e){_.leaveRequests[t.contact_id][e.date]=t})})},_._loadCalendar=function(){return h=e.clone(_.managedContacts),i.get(_.managedContacts.map(function(e){return e.id}),_.selectedPeriod.id).then(function(e){u=e;var t=h.map(function(e){return e.id});u.forEach(function(e){var n=t.indexOf(e.contact_id);h[n].calendarData=_._setCalendarProps(e.contact_id,e)})})},_._loadContacts=function(){return s.all(_._prepareContactFilters(),{page:1,size:0},"display_name").then(function(e){_.filteredContacts=e.list})},_._loadLeaveRequestsAndCalendar=function(){return f._loadLeaveRequestsAndCalendar.call(_,"managed_by",!1,function(){_.managedContacts=h})},_._loadManagees=function(){return m?s.all().then(function(e){_.managedContacts=e.list,_.filteredContacts=e.list}):s.find(_.contactId).then(function(e){return e.leaveManagees().then(function(e){return _.managedContacts=e,_._loadContacts()})})},_._loadRegions=function(){return d.valuesOf("hrjc_region").then(function(e){_.regions=e})},_._loadLocations=function(){return d.valuesOf("hrjc_location").then(function(e){_.locations=e})},_._loadLevelTypes=function(){return d.valuesOf("hrjc_level_type").then(function(e){_.levelTypes=e})},_._loadDepartments=function(){return d.valuesOf("hrjc_department").then(function(e){_.departments=e})},_._prepareContactFilters=function(){var e=_.filters;return{id:{IN:_.filters.contact?[_.filters.contact.id]:_.managedContacts.map(function(e){return e.id})},department:e.department?e.department.value:null,level_type:e.level_type?e.level_type.value:null,location:e.location?e.location.value:null,region:e.region?e.region.value:null}},_._setCalendarProps=function(n,a){var o,r=e.map(_.months,function(t){return e.extend(e.clone(t),{data:[]})});return e.each(a.days,function(e){o=_.leaveRequests[n]?_.leaveRequests[n][e.date]:null,e.UI={isWeekend:a.isWeekend(_._getDateObjectWithFormat(e.date)),isNonWorkingDay:a.isNonWorkingDay(_._getDateObjectWithFormat(e.date)),isPublicHoliday:_.isPublicHoliday(e.date)},o&&(e.UI.styles=_._getStyles(o,e),e.UI.isRequested=_._isPendingApproval(o),e.UI.isAM=_._isDayType("half_day_am",o,e.date),e.UI.isPM=_._isDayType("half_day_pm",o,e.date)),_._getMonthObjectByDate(t(e.date),r).data.push(e)}),r},function(){function t(t,n){var a=n.contact_id,o=e.find(u,function(e){return e.contact_id===a});_.leaveRequests[a]=e.omit(_.leaveRequests[a],function(e){return e.id===n.id}),_._resetMonths(),_._setCalendarProps(a,o)}c(l.permissions.admin.administer).then(function(e){m=e,_._init(function(){return o.all([_._loadRegions(),_._loadDepartments(),_._loadLocations(),_._loadLevelTypes()]).then(function(){return _._loadManagees()})})}),r.$on("LeaveRequest::updatedByManager",_.refresh),r.$on("LeaveRequest::deleted",t)}(),_}n.component("managerLeaveCalendar",{bindings:{contactId:"<"},templateUrl:["shared-settings",function(e){return e.sharedPathTpl+"components/manager-leave-calendar.html"}],controllerAs:"calendar",controller:["$controller","$log","$q","$rootScope","shared-settings","checkPermissions","Calendar","Contact","OptionGroup",a]})});