/*
fraction.js
A Javascript fraction library.

Copyright (c) 2009  Erik Garrison <erik@hypervolu.me>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/

// Copyright CiviCRM LLC 2013. See http://civicrm.org/licensing

define("job-contract/controllers/controllers",["common/angular"],function(e){"use strict";return e.module("hrjc.controllers",[])}),define("job-contract/filters/filters",["common/angular"],function(e){"use strict";return e.module("hrjc.filters",[])}),define("job-contract/filters/get-obj-by-id",["job-contract/filters/filters"],function(e){"use strict";e.filter("getObjById",["$log",function(e){return e.debug("Filter: getObjById"),function(e,t,n){if(!e)return null;var r=0,i=e.length;for(;r<i;r++)if(+e[r].id==+t)return n?e[r][n]:e[r];return null}}])}),define("job-contract/services/services",["common/angular"],function(e){"use strict";return e.module("hrjc.services",[])}),define("job-contract/services/utils",["job-contract/services/services"],function(e){"use strict";e.factory("API",["$resource","$q","settings","$log",function(e,t,n,r){return r.debug("Service: UtilsService"),{resource:function(t,r,i){return!t||typeof t!="string"||!r||typeof r!="string"||i&&typeof i!="object"?null:e(n.pathRest,{action:r,entity:t,json:i})},getOne:function(e,n){if(!e||typeof e!="string"||n&&typeof n!="object")return null;var r=t.defer(),i=angular.extend({sequential:1},n),s;return this.resource(e,"get",i).get(function(e){s=e.values,r.resolve(s.length==1?s[0]:null)},function(){r.reject("Unable to fetch data")}),r.promise},get:function(e,n){if(!e||typeof e!="string"||n&&typeof n!="object")return null;var r=t.defer(),i=angular.extend({sequential:1},n);return this.resource(e,"get",i).get(function(e){r.resolve(e.values)},function(){r.reject("Unable to fetch data")}),r.promise}}}]),e.factory("testAPI",["$resource","settings",function(e,t){return{resource:function(n,r,i){return!n||typeof n!="string"||!r||typeof r!="string"||i&&typeof i!="object"?null:e(t.pathApp+"js/data/"+n+".json",{action:r,entity:n,json:i})}}}]),e.factory("UtilsService",["API","testAPI","settings","$q","$log","$timeout",function(e,t,n,r,i,s){return{getAbsenceType:function(){var t=r.defer();return e.resource("HRAbsenceType","get",{"return":"id,name,title"}).get(function(e){t.resolve(e.values)},function(){t.reject("Unable to fetch absence types")}),t.promise},getHoursLocation:function(){var t=r.defer();return e.resource("HRHoursLocation","get",{sequential:1,is_active:1}).get(function(e){t.resolve(e.values)},function(){t.reject("Unable to fetch standard hours")}),t.promise},getPayScaleGrade:function(){var t=r.defer();return e.resource("HRPayScale","get",{sequential:1}).get(function(e){t.resolve(e.values)},function(){t.reject("Unable to fetch standard hours")}),t.promise},prepareEntityIds:function(e,t,n){function r(e){e.jobcontract_id=t,delete e.id,n?e.jobcontract_revision_id=n:delete e.jobcontract_revision_id}if(angular.isArray(e)){var i=0,s=e.length;for(i;i<s;i++)r(e[i]);return}if(angular.isObject(e)){r(e);return}},errorHandler:function(e,t,n){if(e.is_error)return i.error(e.error_code+"\n"+e.error_message),n&&n.reject(e.error_code+"\n"+e.error_message),e.trace&&i.error(e.trace),!0;if(!e.values)return i.error(t||"Unknown Error"),n&&n.reject(t||"Unknown Error"),!0}}}])}),define("job-contract/services/contract-details",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractDetailsService",["$filter","$resource","settings","$q","UtilsService","$log",function(e,t,n,r,i,s){function u(t){var n=e("formatDate")(t,"YYYY-MM-DD");return n!=="Unspecified"?n:t}s.debug("Service: ContractDetailsService");var o=t(n.pathRest,{action:"get",entity:"HRJobDetails",json:{}});return{validateDates:function(e){if(!e||typeof e!="object"||!e.contact_id||!e.period_start_date)return null;e.period_start_date=u(e.period_start_date),e.period_end_date=u(e.period_end_date),e.sequential=0,e.debug=n.debug;var t=r.defer(),s;return o.save({action:"validatedates",json:e},null,function(e){if(i.errorHandler(e,'Unable to fetch API "validatedates" response',t))return;s=e.values,t.resolve(s)}),t.promise},getOne:function(e){if(!e||typeof e!="object"||!e.jobcontract_id&&!e.jobcontract_revision_id||e.jobcontract_id&&typeof +e.jobcontract_id!="number"||e.jobcontract_revision_id&&typeof +e.jobcontract_revision_id!="number")return null;e.sequential=1,e.debug=n.debug;var t=r.defer(),s;return o.get({json:e},function(e){if(i.errorHandler(e,"Unable to fetch contract details",t))return;s=e.values,t.resolve(s.length==1?s[0]:null)},function(){t.reject("Unable to fetch contract details")}),t.promise},getOptions:function(e,t){var i=r.defer(),s;return t||(s=n.CRM.options.HRJobDetails||{},e&&typeof e=="string"&&(s=s[e]),i.resolve(s||{})),i.promise},getFields:function(e){if(e&&typeof e!="object")return null;if(!e||typeof e!="object")e={};var t=r.defer(),i=n.CRM.fields;return i&&i.HRJobDetails?t.resolve(i.HRJobDetails):(e.sequential=1,o.get({action:"getfields",json:e},function(e){e.values||t.reject("Unable to fetch contract details fields"),t.resolve(e.values)},function(){t.reject("Unable to fetch contract details fields")})),t.promise},save:function(e){if(!e||typeof e!="object")return null;e.period_start_date=u(e.period_start_date),e.period_end_date=u(e.period_end_date);var t=r.defer(),s=angular.extend({sequential:1,debug:n.debug},e),a;return o.save({action:"create",json:s},null,function(e){if(i.errorHandler(e,"Unable to create contract details",t))return;a=e.values,t.resolve(a.length==1?a[0]:null)},function(){t.reject("Unable to create contract details")}),t.promise},model:function(e){function n(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return typeof r.id!="undefined"&&(r.id=null),typeof r.jobcontract_revision_id!="undefined"&&(r.jobcontract_revision_id=null),typeof r.location!="undefined"&&(r.location=null),r}var t=r.defer();return e?t.resolve(n(e)):this.getFields().then(function(e){t.resolve(n(e))}),t.promise}}}])}),define("job-contract/services/contract-hour",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractHourService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,i){i.debug("Service: ContractHourService");var s=e(t.pathRest,{action:"get",entity:"HRJobHour",json:{}});return{getOne:function(e){if(!e||typeof e!="object"||!e.jobcontract_id&&!e.jobcontract_revision_id||e.jobcontract_id&&typeof +e.jobcontract_id!="number"||e.jobcontract_revision_id&&typeof +e.jobcontract_revision_id!="number")return null;e.sequential=1,e.debug=t.debug;var i=n.defer(),o;return s.get({json:e},function(e){if(r.errorHandler(e,"Unable to fetch contract hours",i))return;o=e.values,i.resolve(o.length==1?o[0]:null)},function(){i.reject("Unable to fetch contract hours")}),i.promise},getOptions:function(e,r){var i=n.defer(),s;if(!r){var s=t.CRM.options.HRJobHour||{};e&&typeof e=="string"&&(s=s[e]),i.resolve(s||{})}return i.promise},getFields:function(e){if(e&&typeof e!="object")return null;if(!e||typeof e!="object")e={};var r=n.defer(),i=t.CRM.fields;return i&&i.HRJobHour?r.resolve(i.HRJobHour):(e.sequential=1,s.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract hours fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract hours fields")})),r.promise},save:function(e){if(!e||typeof e!="object")return null;var i=n.defer(),o=angular.extend({sequential:1,debug:t.debug},e),u;return s.save({action:"create",json:o},null,function(e){if(r.errorHandler(e,"Unable to create contract hours",i))return;u=e.values,i.resolve(u.length==1?u[0]:null)},function(){i.reject("Unable to create contract hours")}),i.promise},model:function(e){function r(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return typeof r.id!="undefined"&&(r.id=null),typeof r.jobcontract_revision_id!="undefined"&&(r.jobcontract_revision_id=null),r}var t=n.defer();return e?t.resolve(r(e)):this.getFields().then(function(e){t.resolve(r(e))}),t.promise}}}])}),define("job-contract/services/contract-health",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractHealthService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,i){i.debug("Service: ContractHealthService");var s=e(t.pathRest,{action:"get",entity:"HRJobHealth",json:{}});return{getOne:function(e){if(!e||typeof e!="object"||!e.jobcontract_id&&!e.jobcontract_revision_id||e.jobcontract_id&&typeof +e.jobcontract_id!="number"||e.jobcontract_revision_id&&typeof +e.jobcontract_revision_id!="number")return null;e.sequential=1,e.debug=t.debug;var i=n.defer(),o;return s.get({json:e},function(e){if(r.errorHandler(e,"Unable to fetch contract Health",i))return;o=e.values,i.resolve(o.length==1?o[0]:null)},function(){i.reject("Unable to fetch contract Health")}),i.promise},getOptions:function(e,r){var i=n.defer(),s;if(!r){var s=t.CRM.options.HRJobHealth||{};e&&typeof e=="string"&&(s=s[e]),i.resolve(s||{})}return i.promise},getFields:function(e){if(e&&typeof e!="object")return null;if(!e||typeof e!="object")e={};var r=n.defer(),i=t.CRM.fields;return i&&i.HRJobHealth?r.resolve(i.HRJobHealth):(e.sequential=1,s.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract insurance fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract insurance fields")})),r.promise},save:function(e){if(!e||typeof e!="object")return null;var i=n.defer(),o=angular.extend({sequential:1,debug:t.debug},e),u;return s.save({action:"create",json:o},null,function(e){if(r.errorHandler(e,"Unable to create contract insurance",i))return;u=e.values,i.resolve(u.length==1?u[0]:null)},function(){i.reject("Unable to create contract insurance")}),i.promise},model:function(e){function r(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return typeof r.id!="undefined"&&(r.id=null),typeof r.jobcontract_revision_id!="undefined"&&(r.jobcontract_revision_id=null),r}var t=n.defer();return e?t.resolve(r(e)):this.getFields().then(function(e){t.resolve(r(e))}),t.promise}}}])}),define("job-contract/services/contract-leave",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractLeaveService",["$resource","$q","settings","UtilsService","$log",function(e,t,n,r,i){i.debug("Service: ContractLeaveService");var s=e(n.pathRest,{action:"get",entity:"HRJobLeave",json:{}});return{get:function(e){if(!e||typeof e!="object"||!e.jobcontract_id&&!e.jobcontract_revision_id||e.jobcontract_id&&typeof +e.jobcontract_id!="number"||e.jobcontract_revision_id&&typeof +e.jobcontract_revision_id!="number"||e.id&&typeof +e.id!="number"||e.leaveType&&typeof +e.leaveType!="number")return null;e.sequential=1,e.debug=n.debug;var i=t.defer();return s.get({json:e},function(e){if(r.errorHandler(e,"Unable to fetch contract leave",i))return;i.resolve(e.values)},function(){i.reject("Unable to fetch contract leave")}),i.promise},getOptions:function(e,r){var i=t.defer(),s;if(!r){var s=n.CRM.options.HRJobLeave||{};e&&typeof e=="string"&&(s=s[e]),i.resolve(s||{})}return i.promise},getFields:function(e){if(e&&typeof e!="object")return null;if(!e||typeof e!="object")e={};var r=t.defer(),i=n.CRM.fields;return i&&i.HRJobLeave?r.resolve(i.HRJobLeave):(e.sequential=1,s.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract leave fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract leave fields")})),r.promise},save:function(e){if(!e||typeof e!="object")return null;var i=t.defer(),o={sequential:1,values:e,debug:n.debug};return s.save({action:"replace",json:o},null,function(e){if(r.errorHandler(e,"Unable to create contract leave",i))return;i.resolve(e.values)},function(){i.reject("Unable to create contract details")}),i.promise},model:function(e,n){function s(e,t){var n=0,r=t.length,i=[],s={};for(n;n<r;n++)s[t[n].name]="";return typeof s.id!="undefined"&&(s.id=null),typeof s.jobcontract_revision_id!="undefined"&&(s.jobcontract_revision_id=null),typeof s.location!="undefined"&&(s.location=null),!e||typeof e!="object"||!s||typeof s!="object"||typeof s.leave_type=="undefined"?null:(angular.forEach(e,function(e,t){s.leave_type=t,s.leave_amount=0,i.push(angular.copy(s))}),i)}var r=t.defer(),i=!n||typeof n!="object"?this.getOptions("leave_type"):n;return e?t.when(i).then(function(t){r.resolve(s(t,e))}):this.getFields().then(function(e){t.when(i).then(function(t){r.resolve(s(t,e))})}.bind(this)),r.promise}}}])}),define("job-contract/services/contract-pay",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractPayService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,i){i.debug("Service: ContractPayService");var s=e(t.pathRest,{action:"get",entity:"HRJobPay",json:{}});return{getOne:function(e){if(!e||typeof e!="object"||!e.jobcontract_id&&!e.jobcontract_revision_id||e.jobcontract_id&&typeof +e.jobcontract_id!="number"||e.jobcontract_revision_id&&typeof +e.jobcontract_revision_id!="number")return null;e.sequential=1,e.debug=t.debug;var i=n.defer(),o;return s.get({json:e},function(e){if(r.errorHandler(e,"Unable to fetch contract pay",i))return;o=e.values,i.resolve(o.length==1?o[0]:null)},function(){i.reject("Unable to fetch contract pay")}),i.promise},getOptions:function(e,r){var i=n.defer(),s;if(!r){var s=t.CRM.options.HRJobPay||{};e&&typeof e=="string"&&(s=s[optionGroup]),i.resolve(s||{})}return i.promise},getFields:function(e){if(e&&typeof e!="object")return null;if(!e||typeof e!="object")e={};var r=n.defer(),i=t.CRM.fields;return i&&i.HRJobPay?r.resolve(i.HRJobPay):(e.sequential=1,s.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract pay fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract pay fields")})),r.promise},save:function(e){if(!e||typeof e!="object")return null;var i=n.defer(),o=angular.extend({sequential:1,debug:t.debug},e),u;return s.save({action:"create",json:o},null,function(e){if(r.errorHandler(e,"Unable to create contract pay",i))return;u=e.values,i.resolve(u.length==1?u[0]:null)},function(){i.reject("Unable to create contract pay")}),i.promise},model:function(e){function r(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return typeof r.id!="undefined"&&(r.id=null),typeof r.jobcontract_revision_id!="undefined"&&(r.jobcontract_revision_id=null),typeof r.annual_benefits!="undefined"&&(r.annual_benefits=[]),typeof r.annual_deductions!="undefined"&&(r.annual_deductions=[]),r}var t=n.defer();return e?t.resolve(r(e)):this.getFields().then(function(e){t.resolve(r(e))}),t.promise}}}])}),define("job-contract/services/contract-pension",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractPensionService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,i){i.debug("Service: ContractPensionService");var s=e(t.pathRest,{action:"get",entity:"HRJobPension",json:{}});return{getOne:function(e){if(!e||typeof e!="object"||!e.jobcontract_id&&!e.jobcontract_revision_id||e.jobcontract_id&&typeof +e.jobcontract_id!="number"||e.jobcontract_revision_id&&typeof +e.jobcontract_revision_id!="number")return null;e.sequential=1,e.debug=t.debug;var i=n.defer(),o;return s.get({json:e},function(e){if(r.errorHandler(e,"Unable to fetch contract pension",i))return;o=e.values,i.resolve(o.length==1?o[0]:null)},function(){i.reject("Unable to fetch contract pension")}),i.promise},getOptions:function(e,r){var i=n.defer(),s;if(!r){var s=t.CRM.options.HRJobPension||{};e&&typeof e=="string"&&(s=s[optionGroup]),i.resolve(s||{})}return i.promise},getFields:function(e){if(e&&typeof e!="object")return null;if(!e||typeof e!="object")e={};var r=n.defer(),i=t.CRM.fields;return i&&i.HRJobPension?r.resolve(i.HRJobPension):(e.sequential=1,s.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract pension fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract pension fields")})),r.promise},save:function(e){if(!e||typeof e!="object")return null;var i=n.defer(),o=angular.extend({sequential:1,debug:t.debug},e),u;return s.save({action:"create",json:o},null,function(e){if(r.errorHandler(e,"Unable to create contract pension",i))return;u=e.values,i.resolve(u.length==1?u[0]:null)},function(){i.reject("Unable to create contract pension")}),i.promise},model:function(e){function r(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return typeof r.id!="undefined"&&(r.id=null),typeof r.jobcontract_revision_id!="undefined"&&(r.jobcontract_revision_id=null),r}var t=n.defer();return e?t.resolve(r(e)):this.getFields().then(function(e){t.resolve(r(e))}),t.promise}}}])}),define("job-contract/controllers/contract-list",["job-contract/controllers/controllers","job-contract/filters/get-obj-by-id","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-health","job-contract/services/contract-leave","job-contract/services/contract-pay","job-contract/services/contract-pension","job-contract/services/utils"],function(e){"use strict";e.controller("ContractListCtrl",["$scope","$rootElement","$rootScope","$uibModal","$q","$filter","$sce","contractList","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","UtilsService","settings","$log",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g){g.debug("Controller: ContractListCtrl");var y={details:f,hour:l,pay:c,leave:h,health:p,pension:d},b={hoursLocation:v.getHoursLocation(),payScaleGrade:v.getPayScaleGrade()},w,E={},S={};e.contractListLoaded=!1,e.contractCurrent=[],e.contractPast=[],e.utils={contractListLen:u.length},e.tooltips={changeContractTerms:o.trustAsHtml('<div><p class="text-left"><strong>Change Contract Terms:</strong><br>When an employeees job or role changes, i.e. promotion, secondment or move,you can use this wizard to update the details of the contract and record a newrevision of the contract. A contract history is kept so you can always see theprevious version of the contract.</p><p class="text-left"><strong>Correct an error on the contract record:</strong><br>If you notice an issue or error with the job terms you can correct these withoutcreating a new job history record. These changes are not stored as a new revisionof the contract.</p></div>')};for(w in y)E[w]=y[w].getFields();i.all(E).then(function(t){e.fields=t,g.debug("FIELDS:"),g.debug(t);for(w in y)S[w]=y[w].model(t[w]);return i.all(S)}).then(function(t){e.model=t,g.debug("MODEL:"),g.debug(t),u=s("orderBy")(u,"-is_primary"),angular.forEach(u,function(t){+t.is_current?e.contractCurrent.push(t):e.contractPast.push(t)}),e.$watchCollection("contractCurrent",function(){e.utils.contractListLen=e.contractCurrent.length+e.contractPast.length}),e.$watchCollection("contractPast",function(){e.utils.contractListLen=e.contractCurrent.length+e.contractPast.length}),n.$broadcast("hrjc-loader-hide"),e.contractListLoaded=!0}),i.all(b).then(function(t){angular.extend(e.utils,t)}),e.toggleIsPrimary=function(t){function n(e){var n=0,r=e.length;for(n;n<r;n++)if(+e[n].id!=+t&&+e[n].is_primary)return e[n].is_primary="0",e[n].id;return null}n(e.contractCurrent)||n(e.contractPast),(s("getObjById")(e.contractCurrent,t)||s("getObjById")(e.contractPast,t)||{}).is_primary="1",e.contractCurrent=s("orderBy")(e.contractCurrent,"-is_primary"),e.contractPast=s("orderBy")(e.contractPast,"-is_primary")},e.modalContract=function(n){if(!n||n!=="new")return null;var s,o={appendTo:t.find("div").eq(0),templateUrl:m.pathApp+"views/modalForm.html?v=2222",size:"lg",controller:"ModalContractNewCtrl",windowClass:"modal-contract",resolve:{model:function(){return e.model},utils:function(){return i.all(angular.extend(b,{contractListLen:e.utils.contractListLen}))}}};s=r.open(o),s.result.then(function(t){+t.is_current?e.contractCurrent.push(t):e.contractPast.push(t),+t.is_primary&&e.toggleIsPrimary(t.id)})},e.delete=function(n){function i(t,n){var r=0,i=t.length;for(r;r<i;r++)if(+t[r].id==n)return e.$emit("hrjc-loader-hide"),t.splice(r,1),n;return null}var s=r.open({appendTo:t.find("div").eq(0),templateUrl:m.pathApp+"views/modalDialog.html",size:"sm",controller:"ModalDialogCtrl",resolve:{content:function(){return{msg:"Are you sure you want to delete this job contract?"}}}});s.result.then(function(t){t&&(e.$emit("hrjc-loader-show"),a.delete(n).then(function(t){t.is_error||i(e.contractCurrent,n)||i(e.contractPast,n)}))})}}])}),define("job-contract/services/contact",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContactService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,i){i.debug("Service: ContactService");var s=e(t.pathRest,{action:"getlist",entity:"contact",json:{}});return{getOne:function(e){if(!e||typeof +e!="number")return null;var i=n.defer(),o;return s.get({json:{id:e,debug:t.debug}},function(e){if(r.errorHandler(e,"Unable to fetch contact",i))return;o=e.values,i.resolve(o.length==1?o[0]:null)},function(){i.reject("Unable to fetch contact")}),i.promise},search:function(e,i){if(!e||typeof e=="undefined"||i&&typeof i!="object")return null;var o=n.defer(),i=i||{};return s.get({json:{input:e,params:i,debug:t.debug}},function(e){if(r.errorHandler(e,"Unable to fetch contact list",o))return;o.resolve(e.values)},function(){o.reject("Unable to fetch contact list")}),o.promise}}}])}),define("job-contract/controllers/contract",["job-contract/controllers/controllers","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-pay","job-contract/services/contract-leave","job-contract/services/contract-pension","job-contract/services/contract-health","job-contract/services/contact","job-contract/services/utils","common/filters/angular-date/format-date"],function(e){"use strict";e.controller("ContractCtrl",["$scope","$route","$filter","$uibModal","$rootElement","$q","settings","API","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","ContractFilesService","ContactService","$log",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){function b(t){var n={id:null,jobcontract_id:g,jobcontract_revision_id:t.details.jobcontract_revision_id};angular.extend(e.details,t.details),angular.extend(e.hour,t.hour||n),angular.extend(e.pay,t.pay||n),t.health&&t.health.provider&&t.health.provider!=e.health.provider&&v.getOne(t.health.provider).then(function(t){e.health.provider_contact=t}),t.health&&t.health.provider_life_insurance&&t.health.provider_life_insurance!=e.health.provider_life_insurance&&v.getOne(t.health.provider_life_insurance).then(function(t){e.health.provider_life_insurance_contact=t}),angular.extend(e.health,t.health||n),angular.extend(e.pension,t.pension||n),angular.forEach(e.leave,function(e,r){angular.extend(e,t.leave?t.leave[r]||n:n)})}function w(t){var n;if(e.details.period_end_date?(new Date(e.details.period_end_date)).getTime()!==(new Date(t)).getTime():!!e.details.period_end_date!=!!t)n=!t||(new Date(t)).setHours(0,0,0,0)>=(new Date).setHours(0,0,0,0),n!=!!+e.$parent.contract.is_current&&(n?(e.$parent.contract.is_current="1",e.$parent.$parent.contractCurrent.push(e.$parent.contract),e.$parent.$parent.contractPast.splice(e.$parent.$parent.contractPast.indexOf(e.$parent.contract),1)):(e.$parent.contract.is_current="0",e.$parent.$parent.contractPast.push(e.$parent.contract),e.$parent.$parent.contractCurrent.splice(e.$parent.$parent.contractCurrent.indexOf(e.$parent.contract),1)))}function E(){return y=s.all({details:d.get(e.details.jobcontract_revision_id,"civicrm_hrjobcontract_details"),pension:d.get(e.pension.jobcontract_revision_id,"civicrm_hrjobcontract_pension")}),y.then(function(t){e.files=t}),y}m.debug("Controller: ContractCtrl");var g=e.contract.id,y;e.contractLoaded=!1,e.isCollapsed=!0,e.files={},e.revisionCurrent={},e.revisionList=[],e.revisionDataList=[],angular.extend(e,angular.copy(e.model)),s.all({details:a.getOne({jobcontract_id:g}),hour:f.getOne({jobcontract_id:g}),leave:c.get({jobcontract_id:g}),pension:p.getOne({jobcontract_id:g})}).then(function(e){return s.all({pay:l.getOne({jobcontract_revision_id:e.details.jobcontract_revision_id}),health:h.getOne({jobcontract_revision_id:e.details.jobcontract_revision_id})}).then(function(t){return angular.extend(e,t)})}).then(function(t){b(t),e.contractLoaded=!0,e.$watch("contract.is_primary",function(){e.isCollapsed=!+e.contract.is_primary}),e.$broadcast("hrjc-loader-hide")}).then(E),e.modalContract=function(t,n){e.$broadcast("hrjc-loader-show");var u,v={controller:"ModalContractCtrl",appendTo:i.find("div").eq(0),templateUrl:o.pathApp+"views/modalForm.html?v=4448",windowClass:"modal-contract",size:"lg",resolve:{action:function(){return t||"view"},content:function(){return null},entity:function(){return n?s.all({details:a.getOne({jobcontract_revision_id:n.details_revision_id}),hour:f.getOne({jobcontract_revision_id:n.hour_revision_id}),pay:l.getOne({jobcontract_revision_id:n.pay_revision_id}),leave:c.get({jobcontract_revision_id:n.leave_revision_id}),health:h.getOne({jobcontract_revision_id:n.health_revision_id}),pension:p.getOne({jobcontract_revision_id:n.pension_revision_id})}).then(function(t){var n={contract:e.contract},r={id:null,jobcontract_id:g,jobcontract_revision_id:t.details.jobcontract_revision_id};return angular.extend(n,angular.copy(e.model)),angular.extend(n.details,t.details),angular.extend(n.hour,t.hour||r),angular.extend(n.pay,t.pay||r),angular.forEach(n.leave,function(e,n){angular.extend(e,t.leave?t.leave[n]||r:r)}),angular.extend(n.health,t.health||r),angular.extend(n.pension,t.pension||r),n}):{contract:e.contract,details:e.details,hour:e.hour,pay:e.pay,leave:e.leave,health:e.health,pension:e.pension}},files:function(){return n?s.all({details:d.get(n.details_revision_id,"civicrm_hrjobcontract_details"),pension:d.get(n.pension_revision_id,"civicrm_hrjobcontract_pension")}):y},utils:function(){return e.utils}}};switch(t){case"edit":v.resolve.content=function(){return{allowSave:!0,isDisabled:!1,copy:{close:"Cancel",save:"Save without making a new revision",title:"Edit contract"}}};break;case"change":v.resolve.content=function(){return{allowSave:!0,isDisabled:!1,copy:{close:"Cancel",save:"Save and make a new revision",title:"Change contract terms"}}}}u=r.open(v),u.result.then(function(t){if(!t)return;if(t.revisionCreated){var n=(new Date(t.revisionCreated.effective_date)).setHours(0,0,0,0),r=(new Date(e.revisionCurrent.effective_date)).setHours(0,0,0,0),i=(new Date).setHours(0,0,0,0),o={revisionEntityIdObj:t.revisionCreated,details:t.details,hour:t.hour,pay:t.pay},u=n<=i&&n>=r||r>i&&n<=r;u&&(w(t.details.period_end_date),b(t)),t.files&&(u?E().then(function(e){o.files=e}):s.all({details:d.get(t.revisionCreated.details_revision_id,"civicrm_hrjobcontract_details")}).then(function(e){o.files=e})),e.revisionList.unshift(t.revisionCreated),e.revisionDataList.unshift(o)}else{var a=["details","hour","pay"],f,l;w(t.details.period_end_date),b(t),e.contract.is_primary!=t.contract.is_primary&&e.$parent.$parent.toggleIsPrimary(e.contract.id),angular.forEach(e.revisionDataList,function(n){f=0,l={};while(a[f])n.revisionEntityIdObj[a[f]+"_revision_id"]==e.revisionCurrent[a[f]+"_revision_id"]&&(l[a[f]]=t[a[f]],a[f]=="details"&&t.files&&E().then(function(e){l.files=e,angular.extend(n,l)}),angular.extend(n,l)),f++})}CRM.refreshParent("#hrjobroles")})},e.modalRevision=function(t){e.$broadcast("hrjc-loader-show");if(!t)return null;var a=[],f=t!="leave"?"getOne":"get",l=0,c=e.revisionList.length;for(l;l<c;l++)a.push(u[f]("HRJob"+n("capitalize")(t),{jobcontract_revision_id:e.revisionList[l][t+"_revision_id"]}));var h={appendTo:i.find("div").eq(0),size:"lg",controller:"ModalRevisionCtrl",templateUrl:o.pathApp+"views/modalRevision.html?v=1234",windowClass:"modal-revision",resolve:{entity:function(){return t},fields:function(){return e.$parent.$parent.fields[t]},model:function(){return e.model[t]},utils:function(){return e.utils},revisionDataList:function(){return s.all(a)},revisionList:function(){return e.revisionList},modalContract:function(){return e.modalContract}}};return r.open(h)},e.$on("updateContractView",function(){e.$broadcast("hrjc-loader-show"),s.all({details:a.getOne({jobcontract_revision_id:e.revisionCurrent.details_revision_id}),hour:f.getOne({jobcontract_revision_id:e.revisionCurrent.hour_revision_id}),pay:l.getOne({jobcontract_revision_id:e.revisionCurrent.pay_revision_id}),leave:c.get({jobcontract_revision_id:e.revisionCurrent.leave_revision_id}),health:h.getOne({jobcontract_revision_id:e.revisionCurrent.health_revision_id}),pension:p.getOne({jobcontract_revision_id:e.revisionCurrent.pension_revision_id})}).then(function(t){b(t),e.$broadcast("hrjc-loader-hide")}).then(E)})}])}),define("job-contract/services/contract",["job-contract/services/services"],function(e){"use strict";e.factory("Contract",["$resource","settings","$log",function(e,t,n){return n.debug("Service: Contract"),e(t.pathRest,{action:"get",entity:"HRJobContract",json:{}})}]),e.factory("ContractRevision",["$resource","settings","$log",function(e,t,n){return n.debug("Service: ContractRevision"),e(t.pathRest,{action:"get",entity:"HRJobContractRevision",json:{}})}]),e.factory("ContractService",["Contract","ContractRevision","settings","$q","UtilsService","$log",function(e,t,n,r,i,s){return s.debug("Service: ContractRevision"),{get:function(t){var s=r.defer(),o={};return!CRM||!CRM.jobContractTabApp||!CRM.jobContractTabApp.contractList?(o={sequential:1,contact_id:n.contactId,deleted:0},t&&typeof +t=="number"&&(o.contact_id=t),e.get({json:o},function(e){if(i.errorHandler(e,"Unable to fetch contract list",s))return;s.resolve(e.values)},function(){s.reject("Unable to fetch contract list")})):s.resolve(CRM.jobContractTabApp.contractList),s.promise},getOne:function(t,i){if(!t||typeof +t!="number")return null;var s=r.defer(),o={deleted:0,sequential:1,contact_id:n.contactId,id:t},u;return i&&typeof +i=="number"&&(o.contact_id=i),e.get({json:o},function(e){u=e.values,s.resolve(u.length==1?u[0]:null)},function(){s.reject("Unable to fetch contract data")}),s.promise},getRevision:function(e){if(!e||typeof +e!="number")return null;var n=r.defer(),i={deleted:0,options:{limit:0},sequential:1,jobcontract_id:e};return t.get({json:i},function(e){n.resolve(e.values)},function(){n.reject("Unable to fetch contract revisions")}),n.promise},getRevisionOptions:function(e,t){var i=r.defer(),s;if(!t){var s=n.CRM.options.HRJobContractRevision||{};e&&typeof e=="string"&&(s=s[optionGroup]),i.resolve(s||{})}return i.promise},save:function(t){if(!t||typeof t!="object"||!t.id||typeof +t.id!="number")return null;var n=r.defer(),i=angular.extend({deleted:0,sequential:1},t),s;return e.save({action:"create",json:i},null,function(e){s=e.values,n.resolve(s.length==1?s[0]:null)},function(){n.reject("Unable to fetch contract contract data")}),n.promise},saveRevision:function(e){if(!e||typeof e!="object"||!e.id||typeof +e.id!="number")return null;var n=r.defer(),i=angular.extend({deleted:0,sequential:1},e),s;return t.save({action:"create",json:i},null,function(e){s=e.values,n.resolve(s.length==1?s[0]:null)},function(){n.reject("Unable to fetch contract revision")}),n.promise},"delete":function(t){if(!t||typeof +t!="number")return null;var n=r.defer();return e.delete({action:"deletecontract",json:{id:t}},function(e){n.resolve(e)},function(){n.reject("Could not delete contract ID:"+t)}),n.promise},deleteRevision:function(e){if(!e||typeof +e!="number")return null;var n=r.defer(),i;return t.save({action:"create",json:{sequential:1,deleted:1,id:e}},null,function(e){i=e.values,n.resolve(i.length==1?i[0]:null)},function(){n.reject("Unable to delete contract revision id: "+e)}),n.promise}}}])}),define("job-contract/controllers/revision-list",["job-contract/controllers/controllers","job-contract/services/contract"],function(e){"use strict";e.controller("RevisionListCtrl",["$scope","$filter","$q","$uibModal","$rootElement","settings","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractFilesService","$log",function(e,t,n,r,i,s,o,u,a,f,l,c){function d(){var n,r=0;if(e.revisionList.length){var i=t("orderBy")(e.revisionList,["effective_date","id"]);angular.forEach(i,function(e){(new Date(e.effective_date)).setHours(0,0,0,0)<=(new Date).setHours(0,0,0,0)&&(n=e)});if(!n)do n=i[r],r++;while(i[r]&&i[r-1].effective_date==i[r].effective_date);return angular.extend(e.revisionCurrent,n),n.id}return null}function v(r){e.revisionList.length=0,e.revisionDataList.length=0,o.getRevision(r).then(function(r){var i=[];return r=t("orderBy")(r,["-effective_date","-id"]),e.revisionList.push.apply(e.revisionList,r),angular.forEach(r,function(e){e.effective_date=e.effective_date||"",i.push(n.all({revisionEntityIdObj:e,details:u.getOne({jobcontract_revision_id:e.details_revision_id,"return":"position, location"}),hour:a.getOne({jobcontract_revision_id:e.hour_revision_id,"return":"hours_type"}),pay:f.getOne({jobcontract_revision_id:e.pay_revision_id,"return":"pay_scale, pay_annualized_est, pay_currency"}),files:n.all({details:l.get(e.details_revision_id,"civicrm_hrjobcontract_details")})}))}),n.all(i)}).then(function(t){e.revisionDataList.push.apply(e.revisionDataList,t)})}function m(){var t=s.pathReport+(s.pathReport.indexOf("?")>-1?"&":"?"),n=e.$parent.fields;return angular.forEach(n,function(e,n){t+="fields["+n+"_revision_id]=1&",angular.forEach(e,function(e){t+="fields["+n+"_"+e.name+"]=1&"})}),t+="fields[sort_name]=1&fields[first_name]=1&fields[last_name]=1&fields[external_identifier]=1&fields[email]=1&fields[street_address]=1&fields[city]=1&fields[name]=1&fields[contract_contact_id]=1&fields[contract_contract_id]=1&fields[jobcontract_revision_id]=1&fields[change_reason]=1&fields[created_date]=1&fields[effective_date]=1&fields[modified_date]=1&order_bys[1][column]=id&order_bys[1][order]=ASC&order_bys[2][column]=civicrm_hrjobcontract_revision_revision_id&order_bys[2][order]=ASC&order_bys[3][column]=-&order_bys[3][order]=ASC&order_bys[4][column]=-&order_bys[4][order]=ASC&order_bys[5][column]=-&order_bys[5][order]=ASC&contract_id_op=eq&permission=access+CiviReport&row_count=&_qf_Summary_submit_csv=Preview+CSV&groups=&contract_id_value="+h+"&group_bys[civicrm_hrjobcontract_revision_revision_id]=1",t}c.debug("Controller: RevisionListCtrl");var h=e.contract.id,p=e.revisionDataList=e.$parent.$parent.$parent.$parent.revisionDataList;e.revisionCurrent=e.$parent.$parent.$parent.$parent.revisionCurrent,e.currentPage=1,e.itemsPerPage=5,e.maxSize=5,e.sortCol="revisionEntityIdObj.effective_date",e.sortReverse=!0,e.display={effectiveDate:!0,position:!0,payScale:!0,totalSalary:!0,hours:!0,placeOfWork:!0,recordedBy:!0},e.createPage=function(){var t=(e.currentPage-1)*e.itemsPerPage,n=t+e.itemsPerPage;e.revisionDataListPage=p.slice(t,n)},e.sortBy=function(n,r){typeof n!="undefined"&&(e.sortCol==n?e.sortReverse=!e.sortReverse:e.sortCol=n),typeof r!="undefined"&&(e.sortReverse=r),p=t("orderBy")(e.revisionDataList,e.sortCol,e.sortReverse)},v(h),e.urlCSV=m(),e.deleteRevision=function(t,n){if(e.revisionList.length==1){n.stopPropagation();return}if(!t||typeof +t!="number")return;var u=r.open({appendTo:i.find("div").eq(0),templateUrl:s.pathApp+"views/modalDialog.html",size:"sm",controller:"ModalDialogCtrl",resolve:{content:function(){return{msg:"Are you sure you want to delete this job contract revision?"}}}});u.result.then(function(n){n&&(e.$parent.$parent.$parent.$broadcast("hrjc-loader-show"),o.deleteRevision(t).then(function(n){var r=0,i=e.revisionList.length;if(!n.is_error){for(r;r<i;r++)if(e.revisionList[r].id==t){e.revisionList.splice(r,1),e.revisionDataList.splice(r,1);break}e.sortBy(),e.createPage();if(e.revisionCurrent.id!=d()){e.$emit("updateContractView");return}e.$parent.$parent.$parent.$broadcast("hrjc-loader-hide")}}))})},e.modalRevisionEdit=function(t){var n=t.effective_date,u=t.change_reason,a=r.open({appendTo:i.find("div").eq(0),templateUrl:s.pathApp+"views/modalChangeReason.html?v="+(new Date).getTime(),controller:"ModalChangeReasonCtrl",resolve:{content:function(){return{copy:{title:"Edit revision data"}}},date:function(){return n},reasonId:function(){return u}}});a.result.then(function(r){(r.date!=n||r.reasonId!=u)&&o.saveRevision({id:t.id,change_reason:r.reasonId,effective_date:r.date}).then(function(){t.effective_date=r.date,t.change_reason=r.reasonId,e.sortBy(),e.createPage(),e.revisionCurrent.id!=d()&&e.$emit("updateContractView")})})},e.$watch("currentPage",function(){e.createPage()}),e.$watch("revisionDataList.length",function(t,n){p=e.revisionDataList,t>n&&d(),e.sortBy(),e.createPage()})}])}),define("job-contract/controllers/modal/modal-change-reason",["common/moment","job-contract/controllers/controllers"],function(e,t){"use strict";t.controller("ModalChangeReasonCtrl",["$scope","$uibModalInstance","content","date","reasonId","$log",function(t,n,r,i,s,o){o.debug("Controller: ModalChangeReasonCtrl");var r=r||{},u=r.copy||{};u.title=u.title||"Revision data",t.change_reason=s||"",t.copy=u,t.effective_date=i||"",t.isPast=!1,t.dpOpen=function(e,n){e.preventDefault(),e.stopPropagation(),t[n]=!0},t.save=function(){n.close({reasonId:t.change_reason,date:t.effective_date?e(t.effective_date).format("YYYY-MM-DD"):""})},t.cancel=function(){n.dismiss("cancel")},t.$watch("effective_date",function(e){t.isPast=(new Date(e)).setHours(0,0,0,0)<(new Date).setHours(0,0,0,0)})}])}),define("job-contract/services/contract-files",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractFilesService",["$resource","settings","$q","UtilsService","FileUploader","$log",function(e,t,n,r,i,s){s.debug("Service: ContractFilesService");var o=e(t.pathFile+":action");return i.prototype.queueDelete=[],{"delete":function(e,t,i){if(!e||typeof +e!="number"||!t||typeof +t!="number"||!i||typeof i!="string")return null;var s=n.defer();return o.save({action:"delete",entityTable:i,entityID:t,fileID:e},null,function(e){e.values&&!+e.values[0].result&&(e.is_error=1);if(r.errorHandler(e,"Unable to delete file",s))return;s.resolve(e.values[0])},function(){s.reject("Unable to delete file")}),s.promise},get:function(e,t){if(!e||typeof +e!="number"||!t||typeof t!="string")return null;var i=n.defer();return o.get({action:"list",entityTable:t,entityID:e},function(e){if(r.errorHandler(e,"Unable to fetch files",i))return;i.resolve(e.values)},function(){i.reject("Unable to fetch files")}),i.promise},uploader:function(e,n){if(!e||typeof e!="string")return null;var r={url:t.pathFile+"upload",formData:[{entityTable:e}]};return n&&typeof n=="number"&&(r.queueLimit=n),new i(r)},upload:function(e,t){if(!e||typeof e!="object"||!t||typeof +t!="number")return null;var r=n.defer(),i=[];return e.onBeforeUploadItem=function(e){e.formData.push({entityID:t})},e.onCompleteItem=function(e,t){i.push(t)},e.onErrorItem=function(e,t,n,i){r.reject("Could not upload file: "+e.file.name),s.error(" ===== Item Error: "+n+" ======"),s.error(" =====  - item ======"),s.error(e),s.error(" =====  - response ======"),s.error(t),s.error(" =====  - headers ======"),s.error(i)},e.onCompleteAll=function(){r.resolve(i)},e.uploadAll(),r.promise}}}])}),define("job-contract/controllers/modal/modal-contract",["common/angular","job-contract/controllers/controllers","job-contract/services/contract","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-pay","job-contract/services/contract-leave","job-contract/services/contract-health","job-contract/services/contract-pension","job-contract/services/contract-files","job-contract/services/utils"],function(e,t){"use strict";t.controller("ModalContractCtrl",["$scope","$uibModal","$uibModalInstance","$q","$rootElement","$rootScope","$filter","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","ContractFilesService","action","entity","content","files","UtilsService","utils","settings","$log",function(t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x){function N(e){var t=u("formatDate")(e,Date);return t!=="Unspecified"?t:e}function C(){var e=n.open({appendTo:s.find("div").eq(0),templateUrl:S.pathApp+"views/modalChangeReason.html?v="+(new Date).getTime(),controller:"ModalChangeReasonCtrl",resolve:{content:function(){return{copy:{title:T.title}}},date:null,reasonId:null}});return e.result}function k(){var e=n.open({appendTo:s.find("div").eq(0),templateUrl:S.pathApp+"views/modalConfirmEdit.html?v="+(new Date).getTime(),controller:"ModalDialogCtrl",resolve:{content:function(){return{msg:"Save without making a new revision?"}}}});return e.result}function L(){t.$broadcast("hrjc-loader-show");var o=e.copy(t.entity),u=t.filesTrash,m=t.uploader,g,y,b,w,E,x={contract:a.save(o.contract),details:f.save(o.details),hour:l.save(o.hour),pay:c.save(o.pay),leave:h.save(o.leave),health:p.save(o.health),pension:d.save(o.pension)},T=[],N=[];for(g in u){b=0,w=u[g].length;for(b;b<w;b++)y=u[g][b],N.push(v.delete(y.fileID,y.entityID,y.entityTable))}e.extend(x,{files:N.length?i.all(N):!1}),i.all(x).then(function(r){return e.forEach(m,function(n){e.forEach(n,function(n){e.forEach(n.queue,function(e){e.file.size>t.fileMaxSize&&e.remove()})})}),m.details.contract_file.queue.length&&T.push(v.upload(m.details.contract_file,o.details.jobcontract_revision_id)),m.pension.evidence_file.queue.length&&T.push(v.upload(m.pension.evidence_file,o.pension.jobcontract_revision_id)),r.details.period_start_date=o.details.period_start_date,r.details.period_end_date=o.details.period_end_date,r.pay.annual_benefits=o.pay.annual_benefits,r.pay.annual_deductions=o.pay.annual_deductions,T.length?(E=n.open({appendTo:s.find("div").eq(0),templateUrl:S.pathApp+"views/modalProgress.html?v="+(new Date).getTime(),size:"sm",controller:"ModalProgressCtrl",resolve:{uploader:function(){return m},promiseFilesUpload:function(){return T}}}),r.files=E.result,i.all(r)):r}).then(function(e){t.$broadcast("hrjc-loader-hide"),r.close(e)},function(e){t.$broadcast("hrjc-loader-hide"),CRM.alert(e,"Error","error"),r.dismiss()})}function A(o,u){t.$broadcast("hrjc-loader-show");var m=e.copy(t.entity),y=t.filesTrash,b=t.uploader,E,x,T,N,C=[],k=0,L,A=0,O=0,M,_,D,P,H={},B=[],j=[],F,I={details:f,hour:l,pay:c,leave:h,health:p,pension:d};for(E in I){_=!e.equals(g[E],m[E]);if(!_){_=!!y[E]&&!!y[E].length;if(!_&&b[E])for(T in b[E]){x=b[E][T];if(x.queue.length){_=!0;break}}}_&&(C[O]={},C[O].name=E,C[O].data=m[E],C[O].service=I[E],O++,k=O)}k?(w.prepareEntityIds(C[0].data,g.contract.id),C[0].service.save(C[0].data).then(function(t){F=e.isArray(t)?t[0].jobcontract_revision_id:t.jobcontract_revision_id,O=1,H[C[0].name]=t;for(O;O<k;O++)E=C[O].name,w.prepareEntityIds(C[O].data,g.contract.id,F),H[E]=C[O].service.save(C[O].data);return i.all(e.extend(H,{revisionCreated:a.saveRevision({id:F,change_reason:o,effective_date:u})},{files:!1}))}).then(function(t){for(E in I){t[E]=t[E]||m[E];if(y[E]&&y[E].length){O=0,L=y[E].length;for(O;O<L;O++)N=y[E][O],B.push(v.delete(N.fileID,F,N.entityTable))}}return t.details.period_start_date=m.details.period_start_date,t.details.period_end_date=m.details.period_end_date,t.revisionCreated.effective_date=u||"",t.pay.annual_benefits=m.pay.annual_benefits,t.pay.annual_deductions=m.pay.annual_deductions,e.extend(t.revisionCreated,{details_revision_id:t.details.jobcontract_revision_id,health_revision_id:t.health.jobcontract_revision_id,hour_revision_id:t.hour.jobcontract_revision_id,jobcontract_id:g.contract.id,leave_revision_id:t.leave[0].jobcontract_revision_id,pay_revision_id:t.pay.jobcontract_revision_id,pension_revision_id:t.pension.jobcontract_revision_id}),B.length?(t.files=i.all(B),i.all(t)):t}).then(function(e){O=0;for(O;O<k;O++){E=C[O].name;if(b[E])for(T in b[E]){x=b[E][T],A=x.queue.length,M=0;for(M;M<A;M++)D=x.queue[M],D.file.size>t.fileMaxSize&&(D.remove(),M--,A--);A&&j.push(v.upload(x,F))}}return j.length?(P=n.open({appendTo:s.find("div").eq(0),templateUrl:S.pathApp+"views/modalProgress.html",size:"sm",controller:"ModalProgressCtrl",resolve:{uploader:function(){return b},promiseFilesUpload:function(){return j}}}),e.files=P.result,i.all(e)):e}).then(function(e){t.$broadcast("hrjc-loader-hide"),r.close(e)})):(t.$broadcast("hrjc-loader-hide"),r.close())}x.debug("Controller: ModalContractCtrl");var y=y||{},T=y.copy||{},m=m||"view";T.close=T.close||"Close",T.save=T.save||"Save changes",T.title=T.title||"Contract",t.allowSave=typeof y.allowSave!="undefined"?y.allowSave:!1,t.entity={},t.action=m,t.copy=T,t.fileMaxSize=S.CRM.maxFileSize||0,t.files={},t.filesTrash={},t.isDisabled=typeof y.isDisabled!="undefined"?y.isDisabled:!0,t.isPrimaryDisabled=+g.contract.is_primary,t.showIsPrimary=E.contractListLen>1&&m!="change",t.uploader={details:{contract_file:v.uploader("civicrm_hrjobcontract_details")},pension:{evidence_file:v.uploader("civicrm_hrjobcontract_pension",1)}},t.utils=E,e.copy(g,t.entity),e.copy(b,t.files),t.entity.details.period_start_date=N(t.entity.details.period_start_date),t.entity.details.period_end_date=N(t.entity.details.period_end_date),e.forEach(t.files,function(e,n){t.filesTrash[n]=[]}),r.opened.then(function(){o.$broadcast("hrjc-loader-hide")}),t.cancel=function(){if(m=="view"||e.equals(g,t.entity)&&e.equals(b,t.files)&&!t.uploader.details.contract_file.queue.length&&!t.uploader.pension.evidence_file.queue.length){t.$broadcast("hrjc-loader-hide"),r.dismiss("cancel");return}S.debug&&e.forEach(g,function(n,r){e.equals(n,t.entity[r])||(x.debug("======================"),x.debug("Changed entity: "+r),x.debug("Before:"),x.debug(n),x.debug("After:"),x.debug(t.entity[r]))});var i=n.open({appendTo:s.find("div").eq(0),templateUrl:S.pathApp+"views/modalDialog.html?v="+(new Date).getTime(),size:"sm",controller:"ModalDialogCtrl",resolve:{content:function(){return{copyCancel:"No",title:"Alert",msg:"Are you sure you want to cancel? Changes will be lost!"}}}});i.result.then(function(e){e&&(t.$broadcast("hrjc-loader-hide"),r.dismiss("cancel"))})},t.fileMoveToTrash=function(e,n){var r=t.files[n],i=t.filesTrash[n];i.push(r[e]),r.splice(e,1)},t.filesValidate=function(){var e,n,r=t.fileMaxSize,i=t.uploader,s,o,u,a=!0,f,l;for(e in i){s=i[e];for(n in s){o=s[n],u=o.queue,f=0,l=u.length;for(;f<l&&a;f++)a=u[f].file.size<r}}t.contractForm.$setValidity("maxFileSize",a)},e.forEach(t.uploader,function(n){e.forEach(n,function(e){e.onAfterAddingAll=function(){t.filesValidate()}})}),t.allowSave&&(t.save=function(){t.$broadcast("hrjc-loader-show"),f.validateDates({contact_id:S.contactId,period_start_date:t.entity.details.period_start_date,period_end_date:t.entity.details.period_end_date,jobcontract_id:g.contract.id}).then(function(n){if(n.success){if(e.equals(g,t.entity)&&e.equals(b,t.files)&&!t.uploader.details.contract_file.queue.length&&!t.uploader.pension.evidence_file.queue.length){t.$broadcast("hrjc-loader-hide"),r.dismiss("cancel");return}switch(m){case"edit":t.entity.contract.is_primary==g.contract.is_primary?k().then(function(e){switch(e){case"edit":L();break;case"change":C().then(function(e){A(e.reasonId,e.date)})}}):L();break;case"change":C().then(function(e){A(e.reasonId,e.date)});break;default:t.$broadcast("hrjc-loader-hide"),r.dismiss("cancel");return}}else CRM.alert(n.message,"Error","error"),t.$broadcast("hrjc-loader-hide")},function(e){}),t.$broadcast("hrjc-loader-hide")})}])}),define("job-contract/controllers/modal/modal-contract-new",["common/angular","job-contract/controllers/controllers","job-contract/services/contract","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-pay","job-contract/services/contract-leave","job-contract/services/contract-health","job-contract/services/contract-pension","job-contract/services/contract-files","job-contract/services/utils"],function(e,t){"use strict";t.controller("ModalContractNewCtrl",["$scope","$uibModalInstance","$q","$uibModal","$rootElement","$sce","Contract","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","ContractFilesService","model","UtilsService","utils","settings","$log",function(t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w){w.debug("Controller: ModalContractNewCtrl"),t.allowSave=!0,t.action="new",t.copy={close:"Cancel",save:"Add New Job Contract",title:"Add New Job Contract"},t.entity={},t.isDisabled=!1,t.showIsPrimary=y.contractListLen,t.fileMaxSize=b.CRM.maxFileSize||0,t.uploader={details:{contract_file:v.uploader("civicrm_hrjobcontract_details")},pension:{evidence_file:v.uploader("civicrm_hrjobcontract_pension",1)}},t.utils=y,e.copy(m,t.entity),t.entity.contract={is_primary:0},t.tooltips={fileSize:o.trustAsHtml("<p>THE FILE IS TOO LARGE AND CANNOT BE UPLOADED. PLEASE REDUCE THE SIZE OF THE FILE AND TRY AGAIN.</p>"),fte:o.trustAsHtml("<div><strong>FTE</strong> stands forFull Time Equivalent. This is a useful measure foran organisation that has peopleworking part-time.For a full-time person, FTE is always equal to1.0, whereas for a part-time person, the FTE will representthe fraction of standard hours that the person works on aregular basis.<br>E.g. if the standard working day at an organisationcomprises of 8 hours, then a person who regularly works for8 hours each day would be considered to be full- time andwould have an FTE value of 1.0. A person who regularly worksfor only 4 hours each day would be considered to be apart-time person and would have an FTE value of 0.5. If theorganisation had 10 people, each with an FTE of 1.0 theactual headcount of full-time people would be 10 and theFTE headcount (equal to actual headcount multiplied by theFTE value) would also be 10. However, if the organisationhad another 10 people who each worked part-time with an FTEvalue of 0.5 the actual headcount of part-time people wouldbe 10 while the FTE headcount would only be 5. Thus for anorganisation that had a total of 10 full-time people, and 10part-time people (each with an FTE of 0.5) the actualheadcount for the organisation would be 20 while the FTEheadcount would be 15.</div>")},t.filesValidate=function(){var e,n,r=t.fileMaxSize,i=t.uploader,s,o,u,a=!0,f,l;for(e in i){s=i[e];for(n in s){o=s[n],u=o.queue,f=0,l=u.length;for(;f<l&&a;f++)a=u[f].file.size<r}}t.contractForm.$setValidity("maxFileSize",a)},e.forEach(t.uploader,function(n){e.forEach(n,function(e){e.onAfterAddingAll=function(){t.filesValidate()}})}),t.cancel=function(){n.dismiss("cancel")},t.save=function(){t.$broadcast("hrjc-loader-show");var o=new u;f.validateDates({contact_id:b.contactId,period_start_date:t.entity.details.period_start_date,period_end_date:t.entity.details.period_end_date}).then(function(u){u.success?o.$save({action:"create",json:{sequential:1,contact_id:b.contactId,is_primary:y.contractListLen?t.entity.contract.is_primary:1}},function(o){var u=o.values[0],m=u.id,y=e.copy(t.entity.details),w=t.entity.hour,E=t.entity.pay,S=t.entity.leave,x=t.entity.health,T=t.entity.pension,N,C,k=[],L=t.uploader,A;u.is_current=!y.period_end_date||new Date(y.period_end_date)>new Date,g.prepareEntityIds(y,m),f.save(y).then(function(e){A=e.jobcontract_revision_id},function(e){return CRM.alert(e,"Error","error"),a.delete(m),n.dismiss(),r.reject()}).then(function(){return e.forEach(t.entity,function(e){g.prepareEntityIds(e,m,A)}),C=[l.save(w),c.save(E),h.save(S),p.save(x),d.save(T)],t.uploader.details.contract_file.queue.length&&k.push(v.upload(L.details.contract_file,A)),t.uploader.pension.evidence_file.queue.length&&k.push(v.upload(L.pension.evidence_file,A)),k.length&&(N=i.open({appendTo:s.find("div").eq(0),templateUrl:b.pathApp+"views/modalProgress.html",size:"sm",controller:"ModalProgressCtrl",resolve:{uploader:function(){return L},promiseFilesUpload:function(){return k}}}),C.push(N.result)),r.all(C)},function(e){return CRM.alert(e,"Error","error"),n.dismiss(),r.reject()}).then(function(){t.$broadcast("hrjc-loader-hide"),n.close(u)})},function(e){return t.$broadcast("hrjc-loader-hide"),n.dismiss(),CRM.alert(e.statusText||"Unknown error","Error","error"),r.reject()}):(CRM.alert(u.message,"Error","error"),t.$broadcast("hrjc-loader-hide"))},function(e){})}}])}),define("job-contract/controllers/modal/modal-dialog",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("ModalDialogCtrl",["$scope","$uibModalInstance","$timeout","content","$log",function(e,t,n,r,i){i.debug("Controller: ModalDialogCtrl"),e.title=r.title||"CiviHR Job Contract",e.msg=r.msg||"",e.copyConfirm=r.copyConfirm||"Yes",e.copyCancel=r.copyCancel||"Cancel",e.confirm=function(e){t.close(e||!0)},e.cancel=function(){t.dismiss("Cancel")}}])}),define("job-contract/controllers/modal/modal-progress",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("ModalProgressCtrl",["$scope","$uibModalInstance","$q","$timeout","uploader","promiseFilesUpload","$log",function(e,t,n,r,i,s,o){o.debug("Controller: ModalProgressCtrl");var u,a;e.uploader=i;for(u in i)for(a in i[u])i[u][a].queue.length&&(i[u][a].item=i[u][a].queue[0].file.name),i[u][a].onProgressItem=function(e){this.item=e.file.name};n.all(s).then(function(e){r(function(){t.close(e)},500)}),e.cancel=function(){t.dismiss("File upload canceled")}}])}),define("job-contract/controllers/modal/modal-revision",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("ModalRevisionCtrl",["$scope","$rootScope","$uibModalInstance","$filter","$q","settings","revisionDataList","revisionList","entity","fields","model","modalContract","utils","ContactService","$log",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){function v(){var t=s.pathReport+(s.pathReport.indexOf("?")>-1?"&":"?"),n=e.entity,r,i;return angular.forEach(e.fields,function(e){r=e.name!="editor_name"?e.name:"editor_uid",i=e.extends?"":n+"_",e.selected&&(t+="fields["+i+r+"]=1&")}),t+="fields[sort_name]=1&fields[first_name]=1&fields[last_name]=1&fields[external_identifier]=1&fields[email]=1&fields[street_address]=1&fields[city]=1&fields[name]=1&fields[contract_contact_id]=1&fields[contract_contract_id]=1&fields[jobcontract_revision_id]=1&fields[change_reason]=1&fields[created_date]=1&fields[effective_date]=1&fields[modified_date]=1&order_bys[1][column]=id&order_bys[1][order]=ASC&order_bys[2][column]=civicrm_hrjobcontract_revision_revision_id&order_bys[2][order]=ASC&order_bys[3][column]=-&order_bys[3][order]=ASC&order_bys[4][column]=-&order_bys[4][order]=ASC&order_bys[5][column]=-&order_bys[5][order]=ASC&contract_id_op=eq&permission=access+CiviReport&row_count=&_qf_Summary_submit_csv=Preview+CSV&groups=&contract_id_value="+u[0].jobcontract_id+"&group_bys[civicrm_hrjobcontract_revision_revision_id]=1",t}d.debug("Controller: ModalRevisionCtrl"),e.$broadcast("hrjc-loader-show"),e.currentPage=1,e.entity=a,e.fields=angular.copy(f),e.itemsPerPage=5,e.revisionDataList=[],e.revisionList=[],e.sortCol="effective_date",e.subFields={},e.maxSize=5,e.modalContract=c,e.sortReverse=!0,function(){var t=0,n=e.fields.length,r;for(t;t<n;t++){r=e.fields[t],r.selected=!0,r.isArray=r.name=="leave_type"||r.name=="leave_amount";if(r.name=="id"||r.name=="jobcontract_revision_id"){r.display=!1;continue}r.display=!0}e.fields.unshift({name:"effective_date",title:"Effective Date",display:!0,selected:!0,isArray:!1,"extends":!0}),e.fields.push({name:"editor_name",title:"Change Recorded By",display:!0,selected:!0,isArray:!1,"extends":!0},{name:"change_reason",title:"Reason For Change",display:!0,selected:!0,isArray:!1,"extends":!0})}(),function(){var n=0,i,s,a=o.length,f;for(n;n<a;n++)i=n+1,s=i==a,o[n]||(o[n]=l),!s&&!o[i]&&(o[i]=l),angular.isArray(o[n])?(f=s||o[n][0].jobcontract_revision_id!=o[i][0].jobcontract_revision_id,o[n]={jobcontract_revision_id:o[n][0].jobcontract_revision_id,data:o[n]}):f=s||o[n].jobcontract_revision_id!=o[i].jobcontract_revision_id,f&&(angular.extend(o[n],{effective_date:r("date")(u[n].effective_date,"yyyy/MM/dd")||"",editor_name:u[n].editor_name||"",change_reason:t.options.contract.change_reason[u[n].change_reason]||""}),e.revisionDataList.push(o[n]))}();switch(a){case"hour":(function(){var t;angular.forEach(e.revisionDataList,function(e){e.location_standard_hours&&(t=r("filter")(h.hoursLocation,{id:e.location_standard_hours})[0],e.location_standard_hours=t.location+": "+t.standard_hours+"h per "+t.periodicity)})})();break;case"health":angular.forEach(e.revisionDataList,function(e){e.provider&&p.getOne(e.provider).then(function(t){e.provider=t.label}),e.provider_life_insurance&&p.getOne(e.provider_life_insurance).then(function(t){e.provider_life_insurance=t.label})});break;case"pay":(function(){var n;angular.forEach(e.revisionDataList,function(e){e.pay_scale&&(n=r("filter")(h.payScaleGrade,{id:e.pay_scale})[0]||r("filter")(h.payScaleGrade,{pay_scale:e.pay_scale})[0],e.pay_scale=n.pay_scale+(n.pay_grade?" - "+n.pay_grade:"")+(n.currency?" - "+t.options.pay.pay_currency[n.currency]:"")+(n.amount?" "+n.amount:"")+(n.periodicity?" per "+n.periodicity:""))})})(),r("filter")(e.fields,{name:"pay_is_auto_est"})[0].pseudoconstant=!0,e.subFields={annual_benefits:[{name:"name",title:"Benefit",pseudoconstant:"benefit_name"},{name:"type",title:"Type",pseudoconstant:"benefit_type"},{name:"amount_pct",title:"% amount",pseudoconstant:!1},{name:"amount_abs",title:"Absolute amount",pseudoconstant:!1}],annual_deductions:[{name:"name",title:"Deduction",pseudoconstant:"deduction_name"},{name:"type",title:"Type",pseudoconstant:"deduction_type"},{name:"amount_pct",title:"% amount",pseudoconstant:!1},{name:"amount_abs",title:"Absolute amount",pseudoconstant:!1}]};break;case"pension":r("filter")(e.fields,{name:"is_enrolled"})[0].pseudoconstant=!0}e.urlCSV=v(),e.createPage=function(){var t=(e.currentPage-1)*e.itemsPerPage,n=t+e.itemsPerPage;e.revisionDataListPage=e.revisionDataList.slice(t,n)},e.sortBy=function(t,n){typeof t!="undefined"&&(e.sortCol==t?e.sortReverse=!e.sortReverse:e.sortCol=t),typeof n!="undefined"&&(e.sortReverse=n),e.revisionDataList=r("orderBy")(e.revisionDataList,e.sortCol,e.sortReverse)},e.sortBy(),e.toggleFieldsSelected=function(t){t.selected=!t.selected,e.urlCSV=v()},n.opened.then(function(){t.$broadcast("hrjc-loader-hide")}),e.cancel=function(){n.dismiss("cancel")},e.$watch("currentPage",function(){e.createPage()})}])}),define("job-contract/controllers/form/form-general",["common/moment","job-contract/controllers/controllers","common/filters/angular-date/format-date"],function(e,t){"use strict";t.controller("FormGeneralCtrl",["$scope","$log","HR_settings",function(t,n,r){function s(t,n){if(!t||!n)return"Unspecified";var r,i,s,o;return s=e(n),o=s.diff(t,"years"),s.add(-o,"years"),i=s.diff(t,"months"),s.add(-i,"months"),r=s.diff(t,"days"),o=o>0?o>1?o+" years ":o+" year ":"",i=i>0?i>1?i+" months ":i+" month ":"",r=r>0?r>1?r+" days":r+" day":"",o+i+r||"0 days"}n.debug("Controller: FormGeneralCtrl");var i=t.entity.details;t.format=r.DATE_FORMAT,t.dpOpen=function(e,n){e.preventDefault(),e.stopPropagation(),t[n]=!0},t.$watch("entity.details.period_start_date",function(){e(i.period_start_date),t.dpDateEndMin=e(i.period_start_date).add(1,"day").format(),t.duration=s(i.period_start_date,i.period_end_date)}),t.$watch("entity.details.period_end_date",function(){i.period_end_date?t.dpDateStartMax=e(i.period_end_date).subtract(1,"day").format():(t.dpDateStartMax=null,i.end_reason=null),t.duration=s(i.period_start_date,i.period_end_date)}),t.$watch("entity.details.position",function(e,n){e!=n&&i.title==n&&(t.contractForm.detailsTitle.$setViewValue(e),t.contractForm.detailsTitle.$render())}),t.$watch("entity.details.notice_amount",function(e,n){+e&&!i.notice_unit&&(t.contractForm.detailsNoticeUnit.$setValidity("required",!1),t.contractForm.detailsNoticeUnit.$dirty=!0),e!=n&&i.notice_amount_employee==n&&(i.notice_amount_employee=e)}),t.$watch("entity.details.notice_amount_employee",function(e){+e&&!i.notice_unit_employee&&(t.contractForm.detailsNoticeUnitEmployee.$setValidity("required",!1),t.contractForm.detailsNoticeUnitEmployee.$dirty=!0)}),t.$watch("entity.details.notice_unit",function(e,t){e!=t&&i.notice_unit_employee==t&&(i.notice_unit_employee=e)})}])}),define("job-contract/vendor/fraction",[],function(){var e=function(t,n){if(typeof t!="undefined"&&n)typeof t=="number"&&typeof n=="number"?(this.numerator=t,this.denominator=n):typeof t=="string"&&typeof n=="string"&&(this.numerator=parseInt(t),this.denominator=parseInt(n));else if(typeof n=="undefined"){num=t;if(typeof num=="number")this.numerator=num,this.denominator=1;else if(typeof num=="string"){var r,i,s=num.split(" ");s[0]&&(r=s[0]),s[1]&&(i=s[1]);if(r%1===0&&i&&i.match("/"))return(new e(r)).add(new e(i));if(!r||!!i)return undefined;if(typeof r=="string"&&r.match("/")){var o=r.split("/");this.numerator=o[0],this.denominator=o[1]}else{if(typeof r=="string"&&r.match("."))return new e(parseFloat(r));this.numerator=parseInt(r),this.denominator=1}}}this.normalize()};return e.prototype.clone=function(){return new e(this.numerator,this.denominator)},e.prototype.toString=function(){if(this.denominator==="NaN")return"NaN";var e=this.numerator/this.denominator>0?Math.floor(this.numerator/this.denominator):Math.ceil(this.numerator/this.denominator),t=this.numerator%this.denominator,n=this.denominator,r=[];return e!=0&&r.push(e),t!=0&&r.push((e===0?t:Math.abs(t))+"/"+n),r.length>0?r.join(" "):0},e.prototype.rescale=function(e){return this.numerator*=e,this.denominator*=e,this},e.prototype.add=function(t){var n=this.clone();return t instanceof e?t=t.clone():t=new e(t),td=n.denominator,n.rescale(t.denominator),t.rescale(td),n.numerator+=t.numerator,n.normalize()},e.prototype.subtract=function(t){var n=this.clone();return t instanceof e?t=t.clone():t=new e(t),td=n.denominator,n.rescale(t.denominator),t.rescale(td),n.numerator-=t.numerator,n.normalize()},e.prototype.multiply=function(t){var n=this.clone();if(t instanceof e)n.numerator*=t.numerator,n.denominator*=t.denominator;else{if(typeof t!="number")return n.multiply(new e(t));n.numerator*=t}return n.normalize()},e.prototype.divide=function(t){var n=this.clone();if(t instanceof e)n.numerator*=t.denominator,n.denominator*=t.numerator;else{if(typeof t!="number")return n.divide(new e(t));n.denominator*=t}return n.normalize()},e.prototype.equals=function(t){t instanceof e||(t=new e(t));var n=this.clone().normalize(),t=t.clone().normalize();return n.numerator===t.numerator&&n.denominator===t.denominator},e.prototype.normalize=function(){var t=function(e){return typeof e=="number"&&(e>0&&e%1>0&&e%1<1||e<0&&e%-1<0&&e%-1>-1)},n=function(e,t){if(!t)return Math.round(e);var n=Math.pow(10,t);return Math.round(e*n)/n};return function(){if(t(this.denominator)){var r=n(this.denominator,9),i=Math.pow(10,r.toString().split(".")[1].length);this.denominator=Math.round(this.denominator*i),this.numerator*=i}if(t(this.numerator)){var r=n(this.numerator,9),i=Math.pow(10,r.toString().split(".")[1].length);this.numerator=Math.round(this.numerator*i),this.denominator*=i}var s=e.gcf(this.numerator,this.denominator);this.numerator/=s,this.denominator/=s;if(this.numerator<0&&this.denominator<0||this.numerator>0&&this.denominator<0)this.numerator*=-1,this.denominator*=-1;return this}}(),e.gcf=function(t,n){var r=[],i=e.primeFactors(t),s=e.primeFactors(n);i.forEach(function(e){var t=s.indexOf(e);t>=0&&(r.push(e),s.splice(t,1))});if(r.length===0)return 1;var o=function(){var e=r[0],t;for(t=1;t<r.length;t++)e*=r[t];return e}();return o},e.primeFactors=function(e){var t=Math.abs(e),n=[],r=2;while(r*r<=t)t%r===0?(n.push(r),t/=r):r++;return t!=1&&n.push(t),n},e}),define("job-contract/controllers/form/form-hour",["job-contract/vendor/fraction","job-contract/controllers/controllers"],function(e,t){"use strict";t.controller("FormHourCtrl",["$scope","$rootScope","$filter","$log",function(t,n,r,i){function a(e,n){t.hrsTypeDefined=typeof s.hours_type!="undefined"&&s.hours_type!=null&&s.hours_type!="";if(t.hrsTypeDefined){s.hours_unit=e.periodicity;switch(+n){case 8:s.hours_amount=e.standard_hours;break;case 4:s.hours_amount=s.hours_amount?s.hours_amount:Math.round(e.standard_hours/2);break;case 0:s.hours_amount=s.hours_amount?s.hours_amount:0;break;default:s.hours_amount=""}return}s.hours_unit="",s.hours_amount=""}function f(n,r){r=parseFloat(r)||0,n=parseFloat(n)||0;var i=new e(r,n);s.fte_num=String(+s.hours_type?i.numerator:0),s.fte_denom=String(+s.hours_type?i.denominator:0),s.hours_fte=String(parseFloat((s.fte_num/s.fte_denom||0).toFixed(2))),t.fteFraction=s.fte_num+"/"+s.fte_denom}i.debug("Controller: FormHourCtrl");var s=t.entity.hour,o=t.utils.hoursLocation,u={};t.hrsTypeDefined=!1,s.location_standard_hours=s.location_standard_hours||"1",u=r("getObjById")(o,s.location_standard_hours),t.$watch("entity.hour.location_standard_hours",function(e){u=r("getObjById")(o,e),a(u,s.hours_type),f(u.standard_hours,s.hours_amount)}),t.$watch("entity.hour.hours_type",function(e,t){e!=t&&(a(u,e),f(u.standard_hours,s.hours_amount))}),t.$watch("entity.hour.hours_amount",function(e,t){e!=t&&f(u.standard_hours,e)}),t.$watch("entity.hour.hours_unit",function(e,t){e!=t&&f(u.standard_hours,s.hours_amount)})}])}),define("job-contract/controllers/form/form-health",["job-contract/controllers/controllers","job-contract/services/contact"],function(e){"use strict";e.controller("FormHealthCtrl",["$scope","ContactService","$log",function(e,t,n){n.debug("Controller: FormHealthCtrl"),e.contacts={Health_Insurance_Provider:[],Life_Insurance_Provider:[]},e.refreshContacts=function(n,r){if(!n)return;t.search(n,{contact_type:"Organization",contact_sub_type:r}).then(function(t){e.contacts[r]=t})},e.entity.health.provider&&t.getOne(e.entity.health.provider).then(function(t){e.contacts.Health_Insurance_Provider.push(t)}),e.entity.health.provider_life_insurance&&t.getOne(e.entity.health.provider_life_insurance).then(function(t){e.contacts.Life_Insurance_Provider.push(t)})}])}),define("job-contract/controllers/form/form-pay",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("FormPayCtrl",["$scope","$filter","settings","$log",function(e,t,n,r){function a(){var e=1;switch(+i.pay_cycle){case 1:e=u.Week;break;case 2:e=u.Month}return e}r.debug("Controller: FormPayCtrl");var i=e.entity.pay||{},s={pay_amount:0,pay_currency:n.CRM.defaultCurrency,pay_cycle:"2",pay_unit:"Year"},o=e.utils.payScaleGrade,u={Year:1,Month:12,Week:52,Fortnight:26,Day:260,Hour:2080};e.collapseBenDed=!i.annual_benefits.length&&!i.annual_deductions.length,e.benefits_per_cycle=0..toFixed(2),e.benefits_per_cycle_net=0,e.deductions_per_cycle=0..toFixed(2),i.is_paid=i.is_paid||0,i.pay_is_auto_est="0",i.annual_benefits=i.annual_benefits||[],i.annual_deductions=i.annual_deductions||[],e.add=function(e){e.push({name:"",type:"",amount_pct:"",amount_abs:""})},e.applyPayScaleGradeData=function(){if(i.pay_scale){var e=t("getObjById")(o,i.pay_scale);i.pay_amount=e.amount||s.pay_amount,i.pay_currency=e.currency||s.pay_currency,i.pay_unit=e.periodicity||s.pay_unit}},e.calcAnnualPayEst=function(){+i.is_paid&&(i.pay_annualized_est=(i.pay_amount*u[i.pay_unit]||0).toFixed(2))},e.calcBenefitsPerCycle=function(){if(+i.is_paid){var t=0,n=i.annual_benefits.length,r=0;for(t;t<n;t++)+i.annual_benefits[t].type==2&&(i.annual_benefits[t].amount_abs=(i.annual_benefits[t].amount_pct/100*i.pay_annualized_est).toFixed(2)),r+=+i.annual_benefits[t].amount_abs;e.benefits_per_cycle=(r/a()).toFixed(2)}},e.calcBenefitsPerCycleNet=function(){+i.is_paid&&(e.benefits_per_cycle_net=e.benefits_per_cycle-e.deductions_per_cycle)},e.calcDeductionsPerCycle=function(){if(+i.is_paid){var t=0,n=i.annual_deductions.length,r=0;for(t;t<n;t++)+i.annual_deductions[t].type==2&&(i.annual_deductions[t].amount_abs=(i.annual_deductions[t].amount_pct/100*i.pay_annualized_est).toFixed(2)),r+=+i.annual_deductions[t].amount_abs;e.deductions_per_cycle=(r/a()).toFixed(2)}},e.calcPayPerCycleGross=function(){+i.is_paid&&(i.pay_per_cycle_gross=(i.pay_annualized_est/a()).toFixed(2))},e.calcPayPerCycleNet=function(){+i.is_paid&&(i.pay_per_cycle_net=(+i.pay_per_cycle_gross+ +e.benefits_per_cycle_net).toFixed(2))},e.resetData=function(){i.pay_scale="",i.pay_amount="",i.pay_unit="",i.pay_currency="",i.pay_annualized_est="",i.pay_is_auto_est="",i.annual_benefits=[],i.annual_deductions=[],i.pay_cycle="",i.pay_per_cycle_gross="",i.pay_per_cycle_net="",e.benefits_per_cycle="",e.deductions_per_cycle=""},e.setDefaults=function(){i.pay_cycle=s.pay_cycle,i.pay_currency=s.pay_currency,i.pay_is_auto_est="0",i.pay_amount=0..toFixed(2)},e.remove=function(e,t){e.splice(t,1)},e.$watch("entity.pay.pay_amount",e.calcAnnualPayEst),e.$watch("entity.pay.pay_unit",e.calcAnnualPayEst),e.$watch("entity.pay.pay_annualized_est",function(){e.calcPayPerCycleGross(),e.calcBenefitsPerCycle(),e.calcDeductionsPerCycle()}),e.$watch("entity.pay.annual_benefits",e.calcBenefitsPerCycle,!0),e.$watch("entity.pay.annual_deductions",e.calcDeductionsPerCycle,!0),e.$watch("benefits_per_cycle",e.calcBenefitsPerCycleNet),e.$watch("deductions_per_cycle",e.calcBenefitsPerCycleNet),e.$watch("benefits_per_cycle_net",e.calcPayPerCycleNet),e.$watch("entity.pay.pay_per_cycle_gross",e.calcPayPerCycleNet)}])}),define("job-contract/controllers/form/form-pension",["job-contract/controllers/controllers","job-contract/services/contact"],function(e){"use strict";e.controller("FormPensionCtrl",["$scope","settings","$log",function(e,t,n){n.debug("Controller: FormPensionCtrl")}])}),define("job-contract/directives/directives",["common/angular"],function(e){"use strict";return e.module("hrjc.directives",[])}),define("job-contract/directives/contact",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcContact",["$compile","ContactService","settings","$log",function(e,t,n,r){return r.debug("Directive: hrjcContact"),{restrict:"A",scope:{renderAsLink:"=?hrjcContactLink",contactId:"=?hrjcContact"},template:"{{contact.label}}",link:function(n,r){if(!n.contactId)return;n.$watch("contactId",function(i){t.getOne(n.contactId).then(function(t){n.contact=t,n.renderAsLink&&(r.html('<a ng-href="/civicrm/contact/view?reset=1&cid={{contactId}}">{{contact.label}}</a>'),e(r.contents())(n))})})}}}])}),define("job-contract/directives/loader",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcLoader",["$rootScope","$log",function(e,t){return t.debug("Directive: hrjcLoader"),{link:function(e,t,n){function o(){var e=window.getComputedStyle(t[0]).position;return e=="relative"||e=="absolute"||e=="fixed"}function u(){o()||(t.css("position","relative"),s=!0),t.append(r),i=!0}function a(){i&&r.parentNode.removeChild(r),i=!1,s&&t.css("position","")}var r=document.createElement("div"),i=!1,s=!1;r.className="hrjc-loader",n.hrjcLoaderShow&&u(),e.$on("hrjc-loader-show",function(){u()}),e.$on("hrjc-loader-hide",function(){a()})}}}])}),define("job-contract/directives/number",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcNumber",["$log",function(e){return e.debug("Directive: hrjcNumber"),{require:"ngModel",link:function(e,t,n,r){var i=2,s=n.hrjcNumberFloat||!1;n.hrjcNumber&&typeof +n.hrjcNumber=="number"&&(i=n.hrjcNumber),t.bind("blur",function(){var e=parseFloat(r.$viewValue)||0;r.$setViewValue(s?Math.round(e*100)/100:e.toFixed(i)),r.$render()})}}}])}),define("job-contract/directives/validate",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcValidate",["$log",function(e){return e.debug("Directive: hrjcValidate"),{restrict:"A",require:"^form",scope:{isWarning:"=?hrjcValidateWarning"},link:function(e,t,n,r){function f(e,n){t.toggleClass("has-success",!e&&!n),a.toggleClass("glyphicon-ok",!e&&!n)}function l(e,n){t.toggleClass("has-warning",!e&&n),a.toggleClass("glyphicon-warning-sign",!e&&n)}function c(e){t.toggleClass("has-error",e),a.toggleClass("glyphicon-remove",e)}var i=t[0].querySelector("[name]"),s=angular.element(i),o=s.attr("name"),u=document.createElement("span"),a=angular.element(u);if(!o)return;t.addClass("has-feedback"),a.addClass("glyphicon form-control-feedback"),s.after(a),e.$watch(function(){return r[o]&&r[o].$invalid},function(t){r[o].$dirty&&(f(t,e.isWarning),c(t))}),typeof e.isWarning!="undefined"&&e.$watch("isWarning",function(e){var t=r[o].$invalid;r[o].$dirty&&(f(t,e),l(t,e))}),s.bind("blur",function(){c(r[o].$invalid)})}}}])}),define("job-contract/filters/capitalize",["job-contract/filters/filters"],function(e){"use strict";e.filter("capitalize",["$log",function(e){return e.debug("Filter: capitalize"),function(e){return e?e.replace(/([^\W_]+[^\s-]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):""}}])}),define("job-contract/filters/format-amount",["job-contract/filters/filters"],function(e){"use strict";e.filter("formatAmount",["$log",function(e){return e.debug("Filter: formatAmount"),function(e){return e&&e.indexOf(".")===-1?e+".00":e}}])}),define("job-contract/filters/format-period",["job-contract/filters/filters"],function(e){"use strict";e.filter("formatPeriod",["$filter","$log",function(e,t){return t.debug("Filter: formatPeriod"),function(t){return t?e("date")(t,"yyyy/MM/dd"):"Unspecified"}}])}),define("job-contract/filters/parse-int",["job-contract/filters/filters"],function(e){"use strict";e.filter("parseInt",["$log",function(e){return e.debug("Filter: parseInt"),function(e){return e?parseInt(e):null}}])}),function(e,t){function s(){var e={nodiff:"",year:"year",years:"years",month:"month",months:"months",day:"day",days:"days",hour:"hour",hours:"hours",minute:"minute",minutes:"minutes",second:"second",seconds:"seconds",delimiter:" "};moment.fn.preciseDiff=function(e){return moment.preciseDiff(this,e)},moment.preciseDiff=function(t,n){function l(t,n){return t+" "+e[n+(t===1?"":"s")]}var r=moment(t),i=moment(n);if(r.isSame(i))return e.nodiff;if(r.isAfter(i)){var s=r;r=i,i=s}var o=i.year()-r.year(),u=i.month()-r.month(),a=i.date()-r.date();if(a<0){var f=moment(i.year()+"-"+(i.month()+1),"YYYY-MM").subtract("months",1).daysInMonth();f<r.date()?a=f+a+(r.date()-f):a=f+a,u--}u<0&&(u=12+u,o--);var c=[];return o&&c.push(l(o,"year")),u&&(o&&c.push(","),c.push(l(u,"month"))),a&&(u&&c.push("and"),c.push(l(a,"day"))),c.join(e.delimiter)}}function o(t,n,r){moment.preciseDiff||s();var i=moment(t,"MMMM DD, YYYY"),o="";if(n)var u=moment(n,"MMMM DD, YYYY");var a=moment();if(n)var f=u.diff(a,"days");else var f=a.diff(i,"days");f<0?o=moment.preciseDiff(i,u):o=moment().preciseDiff(i);var l=a.diff(i,"days");l<=0&&(o="0 days"),e("#initial_join_date").remove();var c="<div class='crm-summary-row' id='initial_join_date'><div class='crm-label'>Length Of Employment</div><div class='crm-content crm-custom-data lengthEmployment'></div></div>";e("#custom-set-content-"+r+" .crm-inline-block-content").append(c),e(".lengthEmployment").html(o),n&&f<0&&e(".lengthEmployment").css({color:"#FF0000"})}var n=CRM.grID,r=e("#custom-set-content-"+n+" .crm-inline-block-content div:nth-child(2) .crm-custom-data").html(),i=e("#custom-set-content-"+n+" .crm-inline-block-content div:nth-child(3) .crm-custom-data").html();r&&o(r,i,n),e(document).on("click","#_qf_CustomData_upload",function(){e(document).ajaxSuccess(function(t,r,i){i.extraData&&i.extraData.class_name=="CRM_Contact_Form_Inline_CustomData"&&i.extraData.groupID==n&&setTimeout(function(){var t=e("#custom-set-content-"+n+" .crm-inline-block-content div:nth-child(2) .crm-custom-data").html(),r=e("#custom-set-content-"+n+" .crm-inline-block-content div:nth-child(3) .crm-custom-data").html();t&&o(t,r,n)},300)})})}(CRM.$,CRM._),define("job-contract/app",["common/angular","common/ui-select","job-contract/controllers/controllers","job-contract/controllers/contract-list","job-contract/controllers/contract","job-contract/controllers/revision-list","job-contract/controllers/modal/modal-change-reason","job-contract/controllers/modal/modal-contract","job-contract/controllers/modal/modal-contract-new","job-contract/controllers/modal/modal-dialog","job-contract/controllers/modal/modal-progress","job-contract/controllers/modal/modal-revision","job-contract/controllers/form/form-general","job-contract/controllers/form/form-hour","job-contract/controllers/form/form-health","job-contract/controllers/form/form-pay","job-contract/controllers/form/form-pension","job-contract/directives/directives","job-contract/directives/contact","job-contract/directives/directives","job-contract/directives/loader","job-contract/directives/number","job-contract/directives/validate","job-contract/filters/filters","job-contract/filters/capitalize","job-contract/filters/get-obj-by-id","job-contract/filters/format-amount","job-contract/filters/format-period","job-contract/filters/parse-int","job-contract/services/services","job-contract/services/contract","job-contract/vendor/job-summary","common/services/angular-date/date-format","common/modules/routers/compu-ng-route","common/directives/angular-date/date-input"],function(e){"use strict";e.module("hrjc",["ngAnimate","compuNgRoute","ngResource","ui.bootstrap","ui.select","common.angularDate","angularFileUpload","hrjc.controllers","hrjc.directives","hrjc.filters","hrjc.services"]).constant("settings",{classNamePrefix:"hrjc-",contactId:CRM.jobContractTabApp.contactId,debug:+CRM.debug,pathApp:CRM.jobContractTabApp.path,pathFile:CRM.url("civicrm/hrjobcontract/file/"),pathReport:CRM.url("civicrm/report/hrjobcontract/summary"),pathRest:CRM.url("civicrm/ajax/rest"),pathTpl:CRM.jobContractTabApp.path+"views/",CRM:{options:CRM.FieldOptions||{},defaultCurrency:CRM.jobContractTabApp.defaultCurrency,apiTsFmt:"YYYY-MM-DD HH:mm:ss",fields:CRM.jobContractTabApp.fields,maxFileSize:CRM.jobContractTabApp.maxFileSize}}).config(["settings","$routeProvider","$resourceProvider","$logProvider","$httpProvider","uibDatepickerConfig","uiSelectConfig",function(e,t,n,r,i,s,o){r.debugEnabled(e.debug),t.resolveForAll({format:["DateFormat",function(e){return e.getDateFormat()}]}).when("/",{controller:"ContractListCtrl",templateUrl:e.pathApp+"views/contractList.html?v="+(new Date).getTime(),resolve:{contractList:["ContractService",function(e){return e.get()}]}}).otherwise({redirectTo:"/"}),n.defaults.stripTrailingSlashes=!1,i.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",o.theme="bootstrap",s.showWeeks=!1}]).run(["settings","$rootScope","$q","$log","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService",function(e,t,n,r,i,s,o,u,a,f,l){r.debug("app.run"),t.pathTpl=e.pathTpl,t.prefix=e.classNamePrefix,n.all({contract:i.getRevisionOptions(),details:s.getOptions(),hour:o.getOptions(),pay:u.getOptions(),leave:a.getOptions(),health:f.getOptions(),pension:l.getOptions()}).then(function(e){e.pay.pay_is_auto_est=["No","Yes"],e.pension.is_enrolled=["No","Yes","Opted out"],r.debug("OPTIONS:"),r.debug(e),t.options=e})}])}),function(){var e=CRM.jobContractTabApp.path+"js/src/job-contract";require.config({urlArgs:"bust="+(new Date).getTime(),paths:{"job-contract":e,"job-contract/vendor/fraction":e+"/vendor/fraction","job-contract/vendor/job-summary":e+"/vendor/jobsummary"},shim:{"job-contract/vendor/job-summary":{deps:["common/moment"]}}}),require(["job-contract/app"],function(){"use strict";document.addEventListener("hrjcInit",function(){angular.bootstrap(document.getElementById("hrjob-contract"),["hrjc"])}),document.dispatchEvent(typeof window.CustomEvent=="function"?new CustomEvent("hrjcReady"):function(){var e=document.createEvent("Event");return e.initEvent("hrjcReady",!0,!0),e}())})}(require);