define("contact-summary/modules/contact-summary.config",["common/angular"],function(t){"use strict";return t.module("contactsummary.config",["contactsummary.constants"]).config(["settings","$routeProvider","$resourceProvider","$httpProvider","$logProvider",function(t,e,n,r,c){c.debugEnabled(t.debug),e.when("/",{controller:"ContactSummaryController",controllerAs:"ContactSummaryCtrl",templateUrl:t.pathBaseUrl+t.pathTpl+"mainTemplate.html",resolve:{}}).otherwise({redirectTo:"/"}),n.defaults.stripTrailingSlashes=!1,r.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}])}),define("contact-summary/modules/contact-summary.constants",["common/angular"],function(t){"use strict";return t.module("contactsummary.constants",[]).constant("settings",{classNamePrefix:"contactSummary-",contactId:decodeURIComponent((new RegExp("[?|&]cid=([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null,debug:!0,pathApp:"",pathRest:CRM.url("civicrm/ajax/rest"),pathBaseUrl:CRM.vars.contactsummary.baseURL+"/",pathTpl:"views/"})}),define("contact-summary/controllers/contact-summary.controller",[],function(){"use strict";function t(t,e){t.debug("Controller: ContactSummaryController");var n=e.pathBaseUrl+e.pathTpl,r=this;r.ready=!1,r.partials={keyDetails:n+"/include/keyDetails.html",keyDates:n+"/include/keyDates.html"}}return t.__name="ContactSummaryController",t.$inject=["$log","settings"],t}),define("contact-summary/controllers/key-dates.controller",["common/angular","common/moment"],function(t,e){"use strict";function n(n,r,c,o){function i(t){m.dates.push({title:t.title+" (Start)",date:t.start_date,future:s(t.start_date)}),t.end_date&&m.dates.push({title:t.title+" (End)",date:t.end_date,future:s(t.end_date)})}function a(){r.get().then(function(e){return t.forEach(e,function(t){i(t),"1"===t.is_current&&m.activeContracts++}),c.get()}).then(function(n){t.forEach(n,function(t){var n=e(t.end_date);n.isValid()&&!s(n)||m.activeRoles++})}).finally(function(){m.ready=!0})}function s(t){return e().diff(t)<0}function u(){m.dates=[],a()}n.debug("Controller: KeyDatesController");var m=this;m.ready=!1,m.dates=[],m.activeContracts=0,m.activeRoles=0,function(){a(),o.subscribe("contract-refresh",u)}()}return n.__name="KeyDatesController",n.$inject=["$log","contractService","jobRoleService","pubSub"],n}),define("contact-summary/controllers/key-details.controller",["common/lodash","common/moment"],function(t,e){"use strict";function n(e,n,r,c){function o(){n.get().then(function(t){return a.contactDetails=t,r.getPrimary()}).then(function(e){if(t.isEmpty(e))return void(a.primaryContract=null);a.primaryContract=e}).then(function(t){return r.getLengthOfService()}).then(function(t){a.lengthOfService=t}).finally(function(){a.ready=!0})}function i(){r.resetContracts(),n.data.item={},o()}e.debug("Controller: KeyDetailsController");var a=this;a.ready=!1,function(){o(),c.subscribe("contract-refresh",i)}()}return n.__name="KeyDetailsController",n.$inject=["$log","contactDetailsService","contractService","pubSub"],n}),define("contact-summary/modules/contact-summary.controllers",["common/angular","contact-summary/controllers/contact-summary.controller","contact-summary/controllers/key-dates.controller","contact-summary/controllers/key-details.controller"],function(t,e,n,r){"use strict";t.module("contactsummary.controllers",[]).controller(e.__name,e).controller(n.__name,n).controller(r.__name,r)}),define("contact-summary/modules/contact-summary.core",["common/angular","common/services/pub-sub"],function(t){"use strict";t.module("contactsummary.core",["ngRoute","ngResource","ui.bootstrap","common.services"])}),define("contact-summary/directives/donut-chart.directive",["common/angular","common/d3"],function(t,e){"use strict";function n(t){this.height=this.width=t[0].clientWidth,this.radius=this.width/2||60,this.thickness=this.thickness||15}function r(){return e.svg.arc().innerRadius(this.radius-this.thickness).outerRadius(this.radius)}function c(t,n,r){var c=e.scale.category20();return t.selectAll("path").data(r).enter().append("path").attr("fill",function(t,e){return c(e)}).attr("class",function(t,e){return"chart-color-"+e}).attr("d",n)}function o(){return e.layout.pie().sort(null).value(function(t){return t.value[this.itemKey]}.bind(this))(e.entries(this.items))}function i(t){return e.select(t).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.width/2+","+this.height/2+")")}function a(e){return e.debug("Directive: csDonutChart"),{controllerAs:"CsDonutChartCtrl",restrict:"AE",scope:{radius:"@",thickness:"@",items:"=",itemKey:"@",ready:"="},controller:["$scope","$element",function(e,a){this.drawChart=function(){n.call(t.extend(this,e),a),c(i.call(this,a[0]),r.call(this),o.call(this))}}],link:function(t,e,n,r){var c=t.$watch(function(){return t.ready},function(t,e){!0===t&&(r.drawChart(),c())})}}}return a.__name="csDonutChart",a.$inject=["$log"],a}),define("contact-summary/modules/contact-summary.directives",["common/angular","contact-summary/directives/donut-chart.directive"],function(t,e){"use strict";return t.module("contactsummary.directives",[]).directive(e.__name,e)}),define("contact-summary/modules/contact-summary.run",["common/angular"],function(t){"use strict";return t.module("contactsummary.run",["contactsummary.constants"]).run(["settings","$rootScope","$q","$log",function(t,e,n,r){r.debug("app.run"),e.pathTpl=t.pathTpl,e.prefix=t.classNamePrefix}])}),function(t){define("contact-summary/services/api.service",["common/angular"],function(e){"use strict";function n(n,r){function c(n,r,c,o){if(!e.isDefined(n))throw new Error("Entity name not provided");if(!e.isDefined(c))throw new Error("Action not provided");return r=e.extend({entity:n,action:c,sequential:1,json:1,rowCount:0},r),o?t.param(r):r}function o(t,c,o){return o=e.extend({method:t,url:"/civicrm/ajax/rest"},"post"===t?{data:c}:{params:c},o),n(o).then(function(t){return t.is_error?r.reject(t):t.data}).catch(function(t){return t})}return{get:function(t,e,n){return o("get",c(t,e,"get"),n)},post:function(t,n,r,i){return i=e.extend({headers:{"Content-Type":"application/x-www-form-urlencoded"}},i),o("post",c(t,n,r,!0),i)},getValue:function(t,e){},create:function(t,e){},update:function(t,e){},delete:function(t,e){}}}return n.__name="apiService",n.$inject=["$http","$q"],n})}(CRM.$),define("contact-summary/services/contact-details.service",["common/lodash","common/moment"],function(t,e){"use strict";function n(n,r,c,o,i){function a(){var r=n.defer();if(t.isEmpty(u.getData())){var o=i.contactId;c.get("Contact",{contact_id:o,return:"birth_date"}).then(function(t){if(0===t.values.length)throw new Error("Contact with ID "+o+" not found");var n=t.values[0].birth_date,c=e(n,"YYYY-MM-DD").isValid()?s(n):"";u.setDataKey("id",o),u.setDataKey("dateOfBirth",n),u.setDataKey("age",c),r.resolve()}).catch(function(t){r.reject(t)})}else r.resolve();return r.promise}function s(t){return e().diff(e(t,"YYYY-MM-DD"),"years")}r.debug("Service: contactDetailsService");var u=o.createInstance();return u.get=function(){var t=this,e=n.defer();return a().then(function(){e.resolve(t.getData())}),e.promise},u}return n.__name="contactDetailsService",n.$inject=["$q","$log","apiService","modelService","settings"],n}),define("contact-summary/services/contact.service",["common/lodash"],function(t){"use strict";function e(e,n,r,c,o){function i(){var e=n.defer();return t.isEmpty(u.getData())?a().then(s).then(function(){e.resolve()}):e.resolve(),e.promise}function a(){return c.get().then(function(t){u.setDataKey("id",t.id),u.setDataKey("dateOfBirth",t.dateOfBirth),u.setDataKey("age",t.age)})}function s(){return o.get().then(function(t){u.setDataKey("contract",t)})}e.debug("Service: contactService");var u=r.createInstance();return u.get=function(){var t=this;return i().then(function(){return t.getData()})},u}return e.__name="contactService",e.$inject=["$log","$q","modelService","contactDetailsService","contractService"],e}),define("contact-summary/services/contract.service",["common/angular","common/lodash"],function(t,e){"use strict";function n(n,c,o,i,a){function s(){l.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}}}function u(){var t=n.defer();return e.isEmpty(l.collection.get())?l.getContracts().then(m).finally(function(){t.resolve()}):t.resolve(),t.promise}function m(){var e=n.defer(),r=[];return t.forEach(d,function(t){var e={};e.id=t.id,e.is_primary=t.is_primary,e.is_current=t.is_current,e.revision_id=null,t.api_HRJobContractRevision_getcurrentrevision&&(e.revision_id=t.api_HRJobContractRevision_getcurrentrevision.values.id);var n=l.getContractDetails(t.id).then(function(t){e.title=t.title,e.start_date=t.period_start_date,e.end_date=t.period_end_date,e.type=t.contract_type,e.pay=t.pay,e.hours=t.hours}).then(function(){l.collection.insertItem(t.id,e)});r.push(n)}),n.all(r).catch(function(t){c.error("Something went wrong",t)}).finally(function(){e.resolve()}),e.promise}c.debug("Service: Contract Service");var l={};s(),l.getCollection=function(){return this.collection.get()},l.get=function(){var t=this;return u().then(function(){return t.getCollection()})},l.getPrimary=function(){return this.get().then(function(t){var n=e.sortBy(t,function(t){return[t.end_date,+t.is_primary]});return e.last(n)||{}})},l.resetContracts=function(){d=[],r={},s()},l.getContracts=function(){var t=n.defer();return e.isEmpty(d)?a.get().then(function(t){var e={contact_id:t.id,"api.HRJobContractRevision.getcurrentrevision":{jobcontract_id:"$value.id"}};return o.get("HRJobContract",e)}).then(function(e){var n=e.values.filter(function(t){return 0===parseInt(t.deleted)});if(0===n.length)return t.reject("No job contract found");d=n,t.resolve(d)}).catch(function(e){t.reject(e)}):t.resolve(d),t.promise},l.getContractDetails=function(t){var e=function(t){var e={};0!==t.api_HRJobPay_get.values.length&&(e.amount=t.api_HRJobPay_get.values[0].pay_amount,e.currency=t.api_HRJobPay_get.values[0].pay_currency),t.pay=e},c=function(t){var e={};0!==t.api_HRJobHour_get.values.length&&(e.amount=t.api_HRJobHour_get.values[0].hours_amount,e.unit=t.api_HRJobHour_get.values[0].hours_unit),t.hours=e},i={jobcontract_id:t,"api.HRJobPay.get":{jobcontract_id:t},"api.HRJobHour.get":{jobcontract_id:t}};return r.getContractDetails||(r.getContractDetails=o.post("HRJobDetails",i,"get").then(function(r){if(0===r.values.length)return n.reject("No details found for contract revision with ID "+t);var o=r.values[0];return e(o),c(o),o})),r.getContractDetails},l.getLengthOfService=function(){var t=n.defer();return a.get().then(function(t){return o.post("HRJobContract",{sequential:0,contact_id:t.id},"getlengthofserviceymd")}).then(function(e){e.is_error?t.reject(e):t.resolve(e.values)}).catch(function(e){t.reject(e)}),t.promise};var d=[];return l}var r={};return n.__name="contractService",n.$inject=["$q","$log","apiService","modelService","contactDetailsService"],n}),define("contact-summary/services/item.service",["common/angular","common/moment"],function(t,e){"use strict";function n(){var e={};return e.createInstance=function(){var t=Object.create(this);return t.item={},t},e.get=function(){return this.item},e.set=function(e){if(!t.isObject(e))throw new TypeError("Data must be of type Object");this.item=e},e.setKey=function(t,e){this.item[t]=e},e}return n.__name="itemService",n}),define("contact-summary/services/job-role.service",["common/angular","common/lodash"],function(t,e){"use strict";function n(n,r,c,o,i){function a(){var r=n.defer();return e.isEmpty(s.collection.get())?i.get().then(function(e){var o=[];if(t.forEach(e,function(t){o.push(t.id)}),0===o.length)return n.reject("No job roles found for contracts");c.post("HrJobRoles",{job_contract_id:{IN:o}},"get").then(function(t){if(0===t.values.length)return n.reject("No job roles found for contracts");var e=t.values.map(function(t){return{id:t.id,title:t.title,department:t.department,status:t.status,start_date:t.start_date,end_date:t.end_date}});s.collection.set(e)}).finally(function(){r.resolve()})}):r.resolve(),r.promise}r.debug("Service: jobRoleService");var s={};return s.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}},s.getCollection=function(){return this.collection.get()},s.get=function(){var t=this;return a().then(function(){return t.getCollection()})},s}return n.__name="jobRoleService",n.$inject=["$q","$log","apiService","modelService","contractService"],n}),define("contact-summary/services/leave.service",["common/angular","common/lodash","common/moment"],function(t,e,n){"use strict";function r(r,o,i,a,s,u){function m(){var t,e={};return g.getCurrentPeriod().then(function(e){return t=e,d()}).then(function(n){var r=n.indexOf(t);return-1!==r&&r>0&&(e=n[r-1]),e})}function l(t){var n=r.defer();return e.isEmpty(g.collection.getItem(t))?g.getAbsenceTypes().then(function(){return g.getAbsences(t)}).then(function(){return g.getEntitlement(t)}).then(function(){return f(t)}).then(function(){n.resolve()}).catch(function(t){o.debug("An error has occurred",t),n.reject(t)}):n.resolve(),n.promise}function d(){var t=r.defer();return e.isEmpty(b)?a.get("HRAbsencePeriod").then(function(e){if(0===e.values.length)return t.reject("No absence periods found");b=e.values,b=i("orderBy")(b,"start_date"),t.resolve(b)}).catch(function(e){o.debug("An error has occurred",e),t.reject(e)}):t.resolve(b),t.promise}function f(t){v(t),h(t),y(t)}function v(e){var n=g.collection.getItem(e)||{};t.forEach(C,function(t){if("1"===t.is_active){var e=t.id;n.hasOwnProperty(e)||(n[e]={}),n[e].type_id=e,n[e].title=t.title,n[e].credit_activity_type_id=t.credit_activity_type_id?t.credit_activity_type_id:null,n[e].debit_activity_type_id=t.debit_activity_type_id?t.debit_activity_type_id:null,n[e].entitled=0,n[e].taken=0}}),g.collection.insertItem(e,n)}function h(e){var n=g.collection.getItem(e);t.forEach(_,function(t){var e=t.type_id;n.hasOwnProperty(e)&&"toil"!==n[e].title.toLowerCase()&&(n[e].entitled=+t.amount)}),g.collection.insertItem(e,n)}function y(e){var n=g.collection.getItem(e),r={};t.forEach(C,function(t){t.credit_activity_type_id&&(r[t.credit_activity_type_id]=t.id),t.debit_activity_type_id&&(r[t.debit_activity_type_id]=t.id)}),t.forEach(p,function(t){var e;if(r.hasOwnProperty(t.activity_type_id)&&(e=r[t.activity_type_id]),e){if(!n.hasOwnProperty(e))return;var c=Math.ceil(t.absence_range.approved_duration/60),o=+(c/8).toFixed(1);"toil"===n[e].title.toLowerCase()&&t.activity_type_id===n[e].credit_activity_type_id?n[e].entitled+=o:n[e].taken+=o}}),g.collection.insertItem(e,n)}o.debug("Service: leaveService");var g={};g.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}},g.getCollection=function(){return this.collection.get()},g.getCurrentPeriod=function(){return d().then(function(t){for(var e={},r=n(),c=0;c<t.length;c++){var o=n(t[c].start_date,"YYYY-MM-DD HH:mm:ss"),i=n(t[c].end_date,"YYYY-MM-DD HH:mm:ss");r.diff(o)>=0&&r.diff(i)<=0&&(e=t[c])}return e})},g.get=function(){var t=this;return l(void 0).then(function(){return t.getData()})},g.getCurrent=function(){var t,e=this,n=r.defer();return c.getCurrent||(g.getCurrentPeriod().then(function(r){r.hasOwnProperty("id")?(t=r.id,l(t).then(function(){n.resolve(e.collection.getItem(t))})):n.resolve({})}),c.getCurrent=n.promise),c.getCurrent},g.getPrevious=function(){var t,e=this,n=r.defer();return m().then(function(r){r.hasOwnProperty("id")?(t=r.id,l(t).then(function(){n.resolve(e.collection.getItem(t))})):n.resolve({})}),n.promise},g.getEntitlement=function(t){var e=r.defer();return u.get().then(function(e){var n={contact_id:e.id,period_id:t,options:{"absence-range":1}};return a.get("HRAbsenceEntitlement",n)}).then(function(t){_=t.values,e.resolve(_)}),e.promise},g.getAbsences=function(t){var n=r.defer();return u.get().then(function(e){var n={target_contact_id:e.id,period_id:[t],options:{"absence-range":1},sequential:0};return a.post("Activity",n,"getabsences")}).then(function(t){p=e.filter(t.values,function(t){return"2"===t.status_id}),n.resolve(p)}),n.promise},g.getAbsenceTypes=function(){var t=r.defer();return e.isEmpty(C)?a.get("HRAbsenceType").then(function(e){if(0===e.values.length)throw new Error("No absence type not found");C=e.values,t.resolve(C)}):t.resolve(C),t.promise},g.getStaffAverage=function(t){var e=r.defer();return g.getCurrentPeriod().then(function(n){if(n.hasOwnProperty("id")){var c=n.id;a.post("ContactSummary",{absence_types:t,period_id:c},"getabsenceaggregate").then(function(t){if(0===t.values.length)return r.reject("Staff average not returned");var n=Math.ceil(t.values[0].result/60),c=+(n/8).toFixed(1);e.resolve(c)})}else e.resolve(0)}),e.promise},g.getDepartmentAverage=function(){};var p,_,b,C=[];return g}var c={};return r.__name="leaveService",r.$inject=["$q","$log","$filter","apiService","modelService","contactDetailsService"],r}),define("contact-summary/services/model.service",["contact-summary/modules/contact-summary.services"],function(t){"use strict";function e(t){var e={};return e.data={},e.createInstance=function(){var e=Object.create(this);return e.data=t.createInstance(),e},e.getData=function(){return this.data.get()},e.setData=function(t){this.data.set(t)},e.setDataKey=function(t,e){this.data.setKey(t,e)},e}return e.__name="modelService",e.$inject=["itemService"],e}),define("contact-summary/modules/contact-summary.services",["common/angular","contact-summary/services/api.service","contact-summary/services/contact-details.service","contact-summary/services/contact.service","contact-summary/services/contract.service","contact-summary/services/item.service","contact-summary/services/job-role.service","contact-summary/services/leave.service","contact-summary/services/model.service"],function(t,e,n,r,c,o,i,a,s){"use strict";return t.module("contactsummary.services",[]).factory(e.__name,e).factory(n.__name,n).factory(r.__name,r).factory(c.__name,c).factory(o.__name,o).factory(i.__name,i).factory(a.__name,a).factory(s.__name,s)}),define("contact-summary/modules/contact-summary.module",["common/angular","contact-summary/modules/contact-summary.config","contact-summary/modules/contact-summary.constants","contact-summary/modules/contact-summary.controllers","contact-summary/modules/contact-summary.core","contact-summary/modules/contact-summary.directives","contact-summary/modules/contact-summary.run","contact-summary/modules/contact-summary.services"],function(t){t.module("contactsummary",["contactsummary.core","contactsummary.config","contactsummary.run","contactsummary.constants","contactsummary.controllers","contactsummary.directives","contactsummary.services"])}),function(t,e){e.config({urlArgs:"bust="+(new Date).getTime(),paths:{"contact-summary":t.vars.contactsummary.baseURL+"/js/src/contact-summary"}}),e(["contact-summary/modules/contact-summary.module"],function(){"use strict";document.dispatchEvent("function"==typeof window.CustomEvent?new window.CustomEvent("contactsummaryReady"):function(){var t=document.createEvent("Event");return t.initEvent("contactsummaryReady",!0,!0),t}())})}(CRM,require);