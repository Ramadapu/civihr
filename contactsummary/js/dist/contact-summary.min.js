define("contact-summary/modules/filters",["common/angular"],function(e){"use strict";return e.module("contactsummary.filters",[])}),define("contact-summary/modules/services",["common/angular"],function(e){"use strict";return e.module("contactsummary.services",[])}),define("contact-summary/modules/settings",["common/angular"],function(e){"use strict";return e.module("contactsummary.settings",[]).constant("settings",{classNamePrefix:"contactSummary-",contactId:decodeURIComponent(((new RegExp("[?|&]cid=([^&;]+?)(&|#|;|$)")).exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null,debug:!0,pathApp:"",pathRest:CRM.url("civicrm/ajax/rest"),pathBaseUrl:CRM.vars.contactsummary.baseURL+"/",pathTpl:"views/"})}),define("contact-summary/modules/controllers",["common/angular"],function(e){"use strict";return e.module("contactsummary.controllers",[])}),define("contact-summary/services/item",["common/moment","contact-summary/modules/services"],function(e,t){"use strict";function n(){var e={};return e.createInstance=function(){var e=Object.create(this);return e.item={},e},e.get=function(){return this.item},e.set=function(e){if(!angular.isObject(e))throw new TypeError("Data must be of type Object");this.item=e},e.setKey=function(e,t){this.item[e]=t},e}t.factory("ItemService",n)}),define("contact-summary/services/model",["contact-summary/modules/services","contact-summary/services/item"],function(e){"use strict";function t(e){var t={};return t.data={},t.createInstance=function(){var t=Object.create(this);return t.data=e.createInstance(),t},t.getData=function(){return this.data.get()},t.setData=function(e){this.data.set(e)},t.setDataKey=function(e,t){this.data.setKey(e,t)},t}e.factory("ModelService",["ItemService",t])}),define("contact-summary/services/api",["contact-summary/modules/services"],function(e){"use strict";e.factory("ApiService",["$http","$q",function(e,t){function n(e,t,n,r){if(!angular.isDefined(e))throw new Error("Entity name not provided");if(!angular.isDefined(n))throw new Error("Action not provided");return t=angular.extend({entity:e,action:n,sequential:1,json:1,rowCount:0},t),r?jQuery.param(t):t}function r(n,r,i){return i=angular.extend({cache:!0,method:n,url:"/civicrm/ajax/rest"},n==="post"?{data:r}:{params:r},i),e(i).then(function(e){return e.is_error?t.reject(e):e.data}).catch(function(e){return e})}return{get:function(e,t,i){return r("get",n(e,t,"get"),i)},post:function(e,t,i,s){return s=angular.extend({headers:{"Content-Type":"application/x-www-form-urlencoded"}},s),r("post",n(e,t,i,!0),s)},getValue:function(e,t){},create:function(e,t){},update:function(e,t){},"delete":function(e,t){}}}])}),define("contact-summary/services/contactDetails",["common/lodash","common/moment","contact-summary/modules/services","contact-summary/modules/settings","contact-summary/services/api","contact-summary/services/model"],function(e,t,n){"use strict";function r(n,r,i,s,o){function a(){var r=n.defer();if(e.isEmpty(u.getData())){var s=o.contactId;i.get("Contact",{contact_id:s,"return":"birth_date"}).then(function(e){if(e.values.length===0)throw new Error("Contact with ID "+s+" not found");var n=e.values[0].birth_date,i=t(n,"YYYY-MM-DD").isValid()?t(t(n,"YYYY-MM-DD")).fromNow(!0):"";u.setDataKey("id",s),u.setDataKey("dateOfBirth",n),u.setDataKey("age",i),r.resolve()}).catch(function(e){r.reject(e)})}else r.resolve();return r.promise}r.debug("Service: ContactDetailsService");var u=s.createInstance();return u.get=function(){var e=this,t=n.defer();return a().then(function(){t.resolve(e.getData())}),t.promise},u}n.factory("ContactDetailsService",["$q","$log","ApiService","ModelService","settings",r])}),define("contact-summary/services/leave",["common/lodash","contact-summary/modules/services","contact-summary/services/api","contact-summary/services/model","contact-summary/services/contactDetails"],function(e,t){"use strict";function n(t,n,r,i,s,o){function h(){var e,t={};return u.getCurrentPeriod().then(function(t){return e=t,d()}).then(function(n){var r=n.indexOf(e);return r!==-1&&r>0&&(t=n[r-1]),t})}function p(r){var i=t.defer();return e.isEmpty(u.collection.getItem(r))?u.getAbsenceTypes().then(function(){return u.getAbsences(r)}).then(function(){return u.getEntitlement(r)}).then(function(){return v(r)}).then(function(){i.resolve()}).catch(function(e){n.debug("An error has occurred",e),i.reject(e)}):i.resolve(),i.promise}function d(){var s=t.defer();return e.isEmpty(c)?i.get("HRAbsencePeriod").then(function(e){if(e.values.length===0)return s.reject("No absence periods found");c=e.values,c=r("orderBy")(c,"start_date"),s.resolve(c)}).catch(function(e){n.debug("An error has occurred",e),s.reject(e)}):s.resolve(c),s.promise}function v(e){m(e),g(e),y(e)}function m(e){var t=u.collection.getItem(e)||{};angular.forEach(a,function(e){if(e.is_active!=="1")return;var n=e.id;t.hasOwnProperty(n)||(t[n]={}),t[n].type_id=n,t[n].title=e.title,t[n].credit_activity_type_id=e.credit_activity_type_id?e.credit_activity_type_id:null,t[n].debit_activity_type_id=e.debit_activity_type_id?e.debit_activity_type_id:null,t[n].entitled=0,t[n].taken=0}),u.collection.insertItem(e,t)}function g(e){var t=u.collection.getItem(e);angular.forEach(l,function(e){var n=e.type_id;if(!t.hasOwnProperty(n))return;t[n].title.toLowerCase()!=="toil"&&(t[n].entitled=+e.amount)}),u.collection.insertItem(e,t)}function y(e){var t=u.collection.getItem(e),n={};angular.forEach(a,function(e){e.credit_activity_type_id&&(n[e.credit_activity_type_id]=e.id),e.debit_activity_type_id&&(n[e.debit_activity_type_id]=e.id)}),angular.forEach(f,function(e){var r;n.hasOwnProperty(e.activity_type_id)&&(r=n[e.activity_type_id]);if(r){if(!t.hasOwnProperty(r))return;var i=Math.ceil(e.absence_range.approved_duration/60),s=+(i/8).toFixed(1);t[r].title.toLowerCase()==="toil"?e.activity_type_id===t[r].credit_activity_type_id?t[r].entitled+=s:t[r].taken+=s:t[r].taken+=s}}),u.collection.insertItem(e,t)}n.debug("Service: LeaveService");var u={};u.collection={items:{},insertItem:function(e,t){this.items[e]=t},getItem:function(e){return this.items[e]},set:function(e){this.items=e},get:function(){return this.items}},u.getCollection=function(){return this.collection.get()},u.getCurrentPeriod=function(){return d().then(function(e){var t={},n=moment();for(var r=0;r<e.length;r++){var i=moment(e[r].start_date,"YYYY-MM-DD HH:mm:ss"),s=moment(e[r].end_date,"YYYY-MM-DD HH:mm:ss");n.diff(i)>=0&&n.diff(s)<=0&&(t=e[r])}return t})},u.get=function(){var e=this;return p(periodId).then(function(){return e.getData()})},u.getCurrent=function(){var e=this,n=t.defer(),r;return u.getCurrentPeriod().then(function(t){t.hasOwnProperty("id")?(r=t.id,p(r).then(function(){n.resolve(e.collection.getItem(r))})):n.resolve({})}),n.promise},u.getPrevious=function(){var e=this,n=t.defer(),r;return h().then(function(t){t.hasOwnProperty("id")?(r=t.id,p(r).then(function(){n.resolve(e.collection.getItem(r))})):n.resolve({})}),n.promise},u.getEntitlement=function(e){var n=t.defer();return o.get().then(function(t){var n={contact_id:t.id,period_id:e,options:{"absence-range":1}};return i.get("HRAbsenceEntitlement",n)}).then(function(e){if(e.values.length===0)return{};l=e.values,n.resolve(l)}),n.promise},u.getAbsences=function(n){var r=t.defer();return o.get().then(function(e){var t={target_contact_id:e.id,period_id:[n],options:{"absence-range":1},sequential:0};return i.post("Activity",t,"getabsences")}).then(function(t){f=e.filter(t.values,function(e){return e.status_id==="2"}),r.resolve(f)}),r.promise},u.getAbsenceTypes=function(){var n=t.defer();return e.isEmpty(a)?i.get("HRAbsenceType").then(function(e){if(e.values.length===0)throw new Error("No absence type not found");a=e.values,n.resolve(a)}):n.resolve(a),n.promise},u.getStaffAverage=function(e){var n=t.defer(),r=0;return u.getCurrentPeriod().then(function(s){if(s.hasOwnProperty("id")){var o=s.id;i.post("ContactSummary",{absence_types:e,period_id:o},"getabsenceaggregate").then(function(e){if(e.values.length===0)return t.reject("Staff average not returned");var r=Math.ceil(e.values[0].result/60),i=+(r/8).toFixed(1);n.resolve(i)})}else n.resolve(r)}),n.promise},u.getDepartmentAverage=function(){};var a=[],f,l,c;return u}t.factory("LeaveService",["$q","$log","$filter","ApiService","ModelService","ContactDetailsService",n])}),define("contact-summary/services/contract",["common/lodash","contact-summary/modules/services","contact-summary/services/api","contact-summary/services/contactDetails","contact-summary/services/model"],function(e,t){"use strict";function n(t,n,r,i,s){function a(){var n=t.defer();return e.isEmpty(o.collection.get())?o.getContracts().then(f).finally(function(){n.resolve()}):n.resolve(),n.promise}function f(){var e=t.defer(),r=[];return angular.forEach(u,function(e){var t={};t.id=e.id,t.is_primary=e.is_primary,t.is_current=e.is_current,t.revision_id=null,e.api_HRJobContractRevision_getcurrentrevision&&(t.revision_id=e.api_HRJobContractRevision_getcurrentrevision.values.id);var n=o.getContractDetails(e.id).then(function(e){t.title=e.title,t.start_date=e.period_start_date,t.end_date=e.period_end_date,t.type=e.contract_type,t.pay=e.pay,t.hours=e.hours}).then(function(){o.collection.insertItem(e.id,t)});r.push(n)}),t.all(r).catch(function(e){n.error("Something went wrong",e)}).finally(function(){e.resolve()}),e.promise}n.debug("Service: Contract Service");var o={};o.collection={items:{},insertItem:function(e,t){this.items[e]=t},getItem:function(e){return this.items[e]},set:function(e){this.items=e},get:function(){return this.items}},o.getCollection=function(){return this.collection.get()},o.get=function(){var e=this;return a().then(function(){return e.getCollection()})},o.getPrimary=function(){return this.get().then(function(t){var n=e.sortBy(t,function(e){return[e.end_date,+e.is_primary]});return e.last(n)||{}})},o.getContracts=function(){var n=t.defer();return e.isEmpty(u)?s.get().then(function(e){var t={contact_id:e.id,"api.HRJobContractRevision.getcurrentrevision":{jobcontract_id:"$value.id"}};return r.get("HRJobContract",t)}).then(function(e){var t=e.values.filter(function(e){return parseInt(e.deleted)===0});if(t.length===0)return n.reject("No job contract found");u=t,n.resolve(u)}).catch(function(e){n.reject(e)}):n.resolve(u),n.promise},o.getContractDetails=function(e){var n=function(e){var t={};e.api_HRJobPay_get.values.length!==0&&(t.amount=e.api_HRJobPay_get.values[0].pay_amount,t.currency=e.api_HRJobPay_get.values[0].pay_currency),e.pay=t},i=function(e){var t={};e.api_HRJobHour_get.values.length!==0&&(t.amount=e.api_HRJobHour_get.values[0].hours_amount,t.unit=e.api_HRJobHour_get.values[0].hours_unit),e.hours=t},s={jobcontract_id:e,"api.HRJobPay.get":{jobcontract_id:e},"api.HRJobHour.get":{jobcontract_id:e}};return r.post("HRJobDetails",s,"get").then(function(r){if(r.values.length===0)return t.reject("No details found for contract revision with ID "+e);var s=r.values[0];return n(s),i(s),s})};var u=[];return o}t.factory("ContractService",["$q","$log","ApiService","ModelService","ContactDetailsService",n])}),define("contact-summary/services/contact",["common/lodash","contact-summary/modules/services","contact-summary/services/model","contact-summary/services/leave","contact-summary/services/contactDetails","contact-summary/services/contract"],function(e,t){"use strict";function n(t,n,r,i,s,o){function a(){var t=n.defer();return e.isEmpty(u.getData())?f().then(l).then(c).then(function(){t.resolve()}):t.resolve(),t.promise}function f(){return i.get().then(function(e){u.setDataKey("id",e.id),u.setDataKey("dateOfBirth",e.dateOfBirth),u.setDataKey("age",e.age)})}function l(){return o.get().then(function(e){u.setDataKey("contract",e)})}function c(){return s.get().then(function(e){u.setDataKey("leave",e)})}t.debug("Service: ContactService");var u=r.createInstance();return u.get=function(){var e=this;return a().then(function(){return e.getData()})},u}t.factory("ContactService",["$log","$q","ModelService","ContactDetailsService","LeaveService","ContractService",n])}),define("contact-summary/controllers/contactSummary",["contact-summary/modules/controllers","contact-summary/modules/settings","contact-summary/services/contact"],function(e){"use strict";function t(e,t,n){e.debug("Controller: ContactSummaryCtrl");var r=n.pathBaseUrl+n.pathTpl;this.partials={keyDetails:r+"/include/keyDetails.html",keyDates:r+"/include/keyDates.html",leave:r+"/include/leave.html",sickness:r+"/include/sickness.html"},this.ready=!1}e.controller("ContactSummaryCtrl",["$log","ContactService","settings",t])}),define("contact-summary/services/jobRole",["common/lodash","contact-summary/modules/services","contact-summary/services/api","contact-summary/services/contract","contact-summary/services/model"],function(e,t){"use strict";function n(t,n,r,i,s){function u(){var n=t.defer();return e.isEmpty(o.collection.get())?s.get().then(function(e){var i=[];angular.forEach(e,function(e){i.push(e.id)});if(i.length===0)return t.reject("No job roles found for contracts");r.post("HrJobRoles",{job_contract_id:{IN:i}},"get").then(function(e){if(e.values.length===0)return t.reject("No job roles found for contracts");var n=e.values.map(function(e){return{id:e.id,title:e.title,department:e.department,status:e.status,start_date:e.start_date,end_date:e.end_date}});o.collection.set(n)}).finally(function(){n.resolve()})}):n.resolve(),n.promise}n.debug("Service: JobRoleService");var o={};return o.collection={items:{},insertItem:function(e,t){this.items[e]=t},getItem:function(e){return this.items[e]},set:function(e){this.items=e},get:function(){return this.items}},o.getCollection=function(){return this.collection.get()},o.get=function(){var e=this;return u().then(function(){return e.getCollection()})},o}t.factory("JobRoleService",["$q","$log","ApiService","ModelService","ContractService",n])}),define("contact-summary/controllers/keyDates",["common/moment","contact-summary/modules/controllers","contact-summary/services/contract","contact-summary/services/jobRole"],function(e,t){"use strict";function n(e){this.dates.push({title:e.title+" (Start)",date:e.start_date,future:r(e.start_date)}),e.end_date&&this.dates.push({title:e.title+" (End)",date:e.end_date,future:r(e.end_date)})}function r(t){return e().diff(t)<0}function i(t,i,s){t.debug("Controller: KeyDatesCtrl");var o=this;this.ready=!1,this.dates=[],this.activeContracts=0,this.activeRoles=0,i.get().then(function(e){return angular.forEach(e,function(e){n.call(o,e),e.is_current==="1"&&o.activeContracts++}),s.get()}).then(function(t){angular.forEach(t,function(t){var n=e(t.end_date);(!n.isValid()||r(n))&&o.activeRoles++})}).finally(function(){o.ready=!0})}t.controller("KeyDatesCtrl",["$log","ContractService","JobRoleService",i])}),define("contact-summary/controllers/keyDetails",["common/moment","contact-summary/modules/controllers","contact-summary/services/contactDetails","contact-summary/services/contract"],function(e,t){"use strict";function n(e,t,n){e.debug("Controller: KeyDetailsCtrl"),this.ready=!1,t.get().then(function(e){return this.contactDetails=e,n.getPrimary()}.bind(this)).then(function(e){if(_.isEmpty(e))return;this.primaryContract=e,this.primaryContract.lengthOfService=r(e.start_date,e.end_date)}.bind(this)).finally(function(){this.ready=!0}.bind(this))}function r(t,n){var r=e();t=e(t,"YYYY-MM-DD"),n=n?e(n,"YYYY-MM-DD"):r,n.isAfter(r)&&(n=r);var i=e.duration(n.diff(t));return{days:i.days(),months:i.months(),years:i.years()}}t.controller("KeyDetailsCtrl",["$log","ContactDetailsService","ContractService",n])}),define("contact-summary/controllers/leave",["common/d3","contact-summary/modules/controllers","contact-summary/services/leave"],function(e,t){"use strict";function n(t,n){t.debug("Controller: LeaveCtrl");var r=this;this.leaves=[],this.toil={},this.totalEntitlement=0,this.totalTaken=0,this.ready=!1,this.chartColors=e.scale.category20(),n.getCurrent().then(function(e){angular.forEach(e,function(e){e.title!=="Sick"&&(e.title==="TOIL"?r.toil=e:(r.totalEntitlement+=e.entitled,r.totalTaken+=e.taken,r.leaves.push(e)))})}).finally(function(){r.ready=!0})}t.controller("LeaveCtrl",["$log","LeaveService",n])}),define("contact-summary/controllers/sickness",["contact-summary/modules/controllers","contact-summary/services/leave"],function(e){"use strict";function t(e,t){e.debug("Controller: SicknessCtrl");var n=this;this.taken=0,this.takenPreviously=0,this.staffAverage=0,this.ready=!1,this.currentPeriod="-",t.getStaffAverage("sick").then(function(e){return n.staffAverage=e,t.getCurrent()}).then(function(e){return angular.forEach(e,function(e){e.title==="Sick"&&(n.taken=e.taken)}),t.getPrevious()}).then(function(e){return angular.forEach(e,function(e){e.title==="Sick"&&(n.takenPreviously=e.taken)}),t.getCurrentPeriod()}).then(function(e){n.currentPeriod=e.title}).finally(function(){n.ready=!0})}e.controller("SicknessCtrl",["$log","LeaveService",t])}),define("contact-summary/modules/directives",["common/angular"],function(e){"use strict";return e.module("contactsummary.directives",[])}),define("contact-summary/directives/donutChart",["common/d3","contact-summary/modules/directives"],function(e,t){"use strict";function n(e){this.height=this.width=e[0].clientWidth,this.radius=this.width/2||60,this.thickness=this.thickness||15}function r(){return e.svg.arc().innerRadius(this.radius-this.thickness).outerRadius(this.radius)}function i(t,n,r){var i=e.scale.category20();return t.selectAll("path").data(r).enter().append("path").attr("fill",function(e,t){return i(t)}).attr("class",function(e,t){return"chart-color-"+t}).attr("d",n)}function s(){var t=e.layout.pie().sort(null).value(function(e){return e.value[this.itemKey]}.bind(this));return t(e.entries(this.items))}function o(t){return e.select(t).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.width/2+","+this.height/2+")")}t.directive("csDonutChart",["$log",function(e){return e.debug("Directive: csDonutChart"),{controllerAs:"CsDonutChartCtrl",restrict:"AE",scope:{radius:"@",thickness:"@",items:"=",itemKey:"@",ready:"="},controller:["$scope","$element",function(e,t){this.drawChart=function(){n.call(angular.extend(this,e),t),i(o.call(this,t[0]),r.call(this),s.call(this))}}],link:function(e,t,n,r){var i=e.$watch(function(){return e.ready},function(e,t){e===!0&&(r.drawChart(),i())})}}}])}),define("contact-summary/app",["common/angular","contact-summary/modules/filters","contact-summary/modules/services","contact-summary/modules/settings","contact-summary/controllers/contactSummary","contact-summary/controllers/keyDates","contact-summary/controllers/keyDetails","contact-summary/controllers/leave","contact-summary/controllers/sickness","contact-summary/directives/donutChart"],function(e){var t=e.module("contactsummary",["ngRoute","ngResource","ui.bootstrap","contactsummary.controllers","contactsummary.directives","contactsummary.filters","contactsummary.services","contactsummary.settings"]);t.config(["settings","$routeProvider","$resourceProvider","$httpProvider","$logProvider",function(e,t,n,r,i){i.debugEnabled(e.debug),t.when("/",{controller:"ContactSummaryCtrl",controllerAs:"ContactSummaryCtrl",templateUrl:e.pathBaseUrl+e.pathTpl+"mainTemplate.html",resolve:{}}).otherwise({redirectTo:"/"}),n.defaults.stripTrailingSlashes=!1,r.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),t.run(["settings","$rootScope","$q","$log",function(e,t,n,r){r.debug("app.run"),t.pathTpl=e.pathTpl,t.prefix=e.classNamePrefix}])}),require.config({urlArgs:"bust="+(new Date).getTime(),paths:{"contact-summary":CRM.vars.contactsummary.baseURL+"/js/src/contact-summary"}}),require(["contact-summary/app"],function(){document.addEventListener("contactsummaryLoad",function(){angular.bootstrap(document.getElementById("contactsummary"),["contactsummary"])})});